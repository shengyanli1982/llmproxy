[English](./README.md) | ä¸­æ–‡

<div align="center">
    <img src="./images/logo.png" alt="logo" width="650">
</div>

**ä¸€ä¸ªå…·æœ‰æ™ºèƒ½è°ƒåº¦åŠŸèƒ½çš„é«˜çº§è´Ÿè½½å‡è¡¡ç³»ç»Ÿï¼Œç»Ÿä¸€äº†å„ç§å¤§è¯­è¨€æ¨¡å‹ï¼ˆå…¬å…±/ç§æœ‰äº‘ã€vLLMã€Ollamaï¼‰ï¼Œå®ç°äº†æ— ç¼çš„å¤šäº‘å’Œæ··åˆäº‘é›†æˆï¼Œä¸”ä»…éœ€æœ€å°‘çš„å®¢æˆ·ç«¯ä»£ç ä¿®æ”¹ã€‚**

## ç®€ä»‹

**LLMProxy** æ˜¯ä¸€æ¬¾ä¼ä¸šçº§ã€å®¹é”™æ€§å¼ºçš„ä»£ç†æœåŠ¡ï¼Œä¸“ä¸ºå¤§è¯­è¨€æ¨¡å‹ API è®¾è®¡ã€‚å®ƒæ‹¦æˆªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œä½¿ç”¨å¯é…ç½®çš„è·¯ç”±ç­–ç•¥å°†è¯·æ±‚è½¬å‘åˆ°ä¸Šæ¸¸ LLM API æœåŠ¡å™¨ï¼Œå¹¶å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¯¥è§£å†³æ–¹æ¡ˆè§£å†³äº† LLM API è®¿é—®ä¸­çš„è´¨é‡å’Œå¯é æ€§æŒ‘æˆ˜ï¼Œæä¾›ç²¾ç»†çš„æµé‡ç®¡ç†ï¼Œå¹¶æ˜¾è‘—æé«˜äº† LLM API äº¤äº’çš„ç¨³å®šæ€§ã€æ€§èƒ½å’Œæ•ˆç‡ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© LLMProxyï¼Ÿ

LLMProxy è§£å†³äº†ä¼ä¸š LLM API éƒ¨ç½²ä¸­çš„å…³é”®æŒ‘æˆ˜ï¼š

-   **é«˜å¯ç”¨æ€§** - é€šè¿‡è·¨å¤šä¸ª LLM æä¾›å•†çš„æ™ºèƒ½è¯·æ±‚åˆ†å‘ï¼Œæ¶ˆé™¤å•ç‚¹æ•…éšœ
-   **è´Ÿè½½å‡è¡¡** - å®æ–½å¤æ‚çš„è´Ÿè½½åˆ†é…ç­–ç•¥ï¼Œä¼˜åŒ–èµ„æºåˆ©ç”¨å¹¶åœ¨ä¸åŒè´Ÿè½½ä¸‹ç»´æŒæ€§èƒ½
-   **å®¹é”™èƒ½åŠ›** - é‡‡ç”¨æ–­è·¯å™¨æ¨¡å¼æ£€æµ‹æ•…éšœä¸Šæ¸¸æœåŠ¡ï¼Œé˜²æ­¢çº§è”æ•…éšœï¼Œå¹¶åœ¨æœåŠ¡æ¢å¤æ—¶è‡ªåŠ¨æ¢å¤
-   **æ°´å¹³æ‰©å±•æ€§** - é€šè¿‡æ·»åŠ æ›´å¤šä¸Šæ¸¸æœåŠ¡è½»æ¾åº”å¯¹ä¸æ–­å¢é•¿çš„è¯·æ±‚é‡ï¼Œè€Œä¸ä¼šå½±å“ç°æœ‰å®¢æˆ·ç«¯

## æ ¸å¿ƒåŠŸèƒ½

-   ğŸ”„ **é«˜çº§è¯·æ±‚è½¬å‘**

    -   é€šè¿‡`http_server.forwards`é…ç½®å¤šä¸ªç‹¬ç«‹çš„è½¬å‘æœåŠ¡
    -   ç²¾ç¡®æ§åˆ¶æ¯ä¸ªè½¬å‘æœåŠ¡çš„å•ç‹¬å‘½åå’Œé…ç½®
    -   ä¸ºæ¯ä¸ªè½¬å‘æœåŠ¡å®šä¹‰ç‰¹å®šçš„ç›‘å¬åœ°å€å’Œç«¯å£é…ç½®
    -   ä½¿ç”¨æ˜ç¡®çš„è·¯ç”±è§„åˆ™å°†æ¯ä¸ªè½¬å‘æœåŠ¡æ˜ å°„åˆ°æŒ‡å®šçš„ä¸Šæ¸¸ç»„

-   ğŸŒ **å…¨é¢çš„ä¸Šæ¸¸ç®¡ç†**

    -   é€šè¿‡`upstreams`å®šä¹‰å’Œç¼–æ’å¤šä¸ªåç«¯ LLM API æœåŠ¡
    -   ç‹¬ç«‹å‘½åã€é…ç½®å’Œç®¡ç†æ¯ä¸ªä¸Šæ¸¸æœåŠ¡
    -   æ”¯æŒä¼ä¸šçº§èº«ä»½éªŒè¯æœºåˆ¶ï¼š
        -   Bearer ä»¤ç‰Œè®¤è¯
        -   åŸºæœ¬è®¤è¯
        -   æ— è®¤è¯ï¼ˆé»˜è®¤ï¼‰
    -   ç²¾ç¡®çš„ HTTP å¤´éƒ¨æ“ä½œï¼š
        -   `insert`ï¼šåœ¨ä¸å­˜åœ¨æ—¶æ·»åŠ å¤´éƒ¨
        -   `remove`ï¼šåˆ é™¤æŒ‡å®šå¤´éƒ¨
        -   `replace`ï¼šæ›¿æ¢ç°æœ‰å¤´éƒ¨æˆ–åœ¨ä¸å­˜åœ¨æ—¶æ·»åŠ 

-   âš¡ **å¤æ‚çš„è´Ÿè½½å‡è¡¡**

    -   ä½¿ç”¨`upstream_groups`å°†ä¸Šæ¸¸æœåŠ¡ç»„ç»‡æˆé€»è¾‘åŠŸèƒ½ç»„
    -   æ”¯æŒå¤šç§é«˜çº§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š
        -   **è½®è¯¢ï¼ˆRRï¼‰** - åœ¨æœåŠ¡å™¨ä¹‹é—´å…¬å¹³åˆ†é…
        -   **åŠ æƒè½®è¯¢ï¼ˆWRRï¼‰** - æ ¹æ®å®¹é‡å’Œæ€§èƒ½ä¼˜å…ˆè€ƒè™‘æœåŠ¡å™¨
        -   **éšæœº** - éç¡®å®šæ€§é€‰æ‹©ï¼Œå¢å¼ºå®‰å…¨æ€§å’Œéšç§æ€§
        -   **å“åº”æ—¶é—´æ„ŸçŸ¥** - åŠ¨æ€ä¼˜å…ˆé€‰æ‹©å“åº”æ›´å¿«ã€è´Ÿè½½æ›´ä½çš„æœåŠ¡å™¨
    -   åœ¨åŠ æƒè½®è¯¢ç­–ç•¥ä¸­ä¸ºæ¯ä¸ªä¸Šæ¸¸é…ç½®æƒé‡ï¼ˆå…¶ä»–ç­–ç•¥ä¸ä½¿ç”¨æƒé‡å€¼ï¼‰

-   ğŸ” **ç²¾ç»†çš„æµé‡æ§åˆ¶**

    -   ä¸ºæ¯ä¸ªè½¬å‘æœåŠ¡å®æ–½å…·æœ‰ç²¾ç¡®é˜ˆå€¼çš„é€Ÿç‡é™åˆ¶
    -   é…ç½®é€‚åˆæœåŠ¡å®¹é‡çš„æ¯ç§’è¯·æ±‚é™åˆ¶
    -   å®šä¹‰çªå‘å®¹é‡ï¼Œæœ‰æ•ˆå¤„ç†æµé‡å³°å€¼
    -   éƒ¨ç½²åŸºäº IP çš„é€Ÿç‡é™åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨å¹¶ç¡®ä¿å…¬å¹³èµ„æºåˆ†é…

-   ğŸ”Œ **ä¼ä¸šçº§è¿æ¥æ€§**

    -   **å…¥ç«™è¿æ¥ç®¡ç†ï¼š** ä¸ºå®¢æˆ·ç«¯è¿æ¥é…ç½®ç²¾ç¡®çš„è¶…æ—¶æ—¶é—´
    -   **å‡ºç«™è¿æ¥å’Œè¯·æ±‚ä¼˜åŒ–ï¼š**
        -   å¯è‡ªå®šä¹‰çš„ User-Agent æ ‡è¯†
        -   TCP ä¿æ´»é…ç½®ï¼Œç¡®ä¿è¿æ¥ç¨³å®š
        -   å¯é…ç½®çš„è¿æ¥ã€è¯·æ±‚å’Œç©ºé—²è¶…æ—¶
        -   å…·æœ‰å¯é…ç½®å°è¯•æ¬¡æ•°å’Œé€€é¿å»¶è¿Ÿçš„æ™ºèƒ½é‡è¯•æœºåˆ¶
        -   å¯é€‰çš„ HTTP/HTTPS ä»£ç†æ”¯æŒï¼Œå¢å¼ºå®‰å…¨æ€§å’Œåˆè§„æ€§

-   ğŸ›¡ï¸ **é«˜çº§å®¹é”™èƒ½åŠ›**

    -   **æ–­è·¯å™¨æ¨¡å¼ï¼š** è‡ªåŠ¨æ£€æµ‹å¹¶éš”ç¦»æ•…éšœä¸Šæ¸¸æœåŠ¡
    -   **å¿«é€Ÿæ•…éšœæ£€æµ‹ï¼š** å¿«é€Ÿè¯†åˆ«é—®é¢˜æœåŠ¡ï¼Œæœ€å°åŒ–è¯·æ±‚å»¶è¿Ÿ
    -   **è‡ªåŠ¨æ¢å¤ï¼š** å®šæœŸæµ‹è¯•æ•…éšœæœåŠ¡å¹¶åœ¨å¯ç”¨æ—¶æ¢å¤
    -   **å¯é…ç½®é˜ˆå€¼ï¼š** é’ˆå¯¹æ¯ä¸ªä¸Šæ¸¸æœåŠ¡å¾®è°ƒæ•…éšœæ£€æµ‹çµæ•åº¦ï¼ˆæ•…éšœç‡å’Œå†·å´æ—¶é—´ï¼‰
    -   **æ•…éšœéš”ç¦»ï¼š** é€šè¿‡é™åˆ¶é—®é¢˜åœ¨å—å½±å“çš„ä¸Šæ¸¸æœåŠ¡å†…ï¼Œé˜²æ­¢çº§è”æ•…éšœ
    -   **æ™ºèƒ½æ•…éšœè½¬ç§»ï¼š** å½“ä¸€ä¸ªä¸Šæ¸¸æœåŠ¡ç†”æ–­æ—¶ï¼Œè‡ªåŠ¨å°†æµé‡è½¬å‘åˆ°åŒä¸€ç»„å†…çš„å¥åº·æœåŠ¡

-   ğŸ“Š **å…¨é¢çš„ç›‘æ§å’Œç®¡ç†**

    -   é€šè¿‡`http_server.admin`æä¾›ç‹¬ç«‹çš„ç®¡ç†ç•Œé¢
    -   ç”¨äºè¿è¥ç›‘æ§å’Œå‘Šè­¦çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹
    -   ç”¨äºè¯¦ç»†æ€§èƒ½åˆ†æçš„ Prometheus æŒ‡æ ‡

## æ¶æ„

LLMProxy å®ç°äº†æ¨¡å—åŒ–ã€é¢å‘å¾®æœåŠ¡çš„æ¶æ„ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®ç»„ä»¶ï¼š

-   **è½¬å‘æœåŠ¡å™¨**ï¼šæ¥æ”¶å’Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„ HTTP ç›‘å¬å™¨
-   **ä¸Šæ¸¸ç®¡ç†å™¨**ï¼šç¼–æ’ä¸ LLM API æœåŠ¡å™¨çš„é€šä¿¡ï¼ŒåŒ…æ‹¬è´Ÿè½½å‡è¡¡å’Œèº«ä»½éªŒè¯
-   **è´Ÿè½½å‡è¡¡å™¨**ï¼šæ ¹æ®é…ç½®çš„ç­–ç•¥ï¼ˆè½®è¯¢ã€åŠ æƒè½®è¯¢ã€éšæœºæˆ–å“åº”æ—¶é—´æ„ŸçŸ¥ï¼‰åœ¨å¯ç”¨ä¸Šæ¸¸ä¹‹é—´æ™ºèƒ½åˆ†é…è¯·æ±‚ï¼ŒåŠ¨æ€é€‚åº”ä¸Šæ¸¸æ€§èƒ½å’Œè´Ÿè½½æƒ…å†µ
-   **æ–­è·¯å™¨**ï¼šç›‘æ§ä¸Šæ¸¸å¥åº·çŠ¶å†µï¼Œæ£€æµ‹æŒç»­å¤±è´¥çš„æœåŠ¡ï¼Œè‡ªåŠ¨ç†”æ–­å¹¶éš”ç¦»é—®é¢˜æœåŠ¡ï¼Œé˜²æ­¢çº§è”æ•…éšœï¼Œå¹¶åœ¨æœåŠ¡æ¢å¤åè‡ªåŠ¨é‡æ–°å¯ç”¨
-   **æŒ‡æ ‡æ”¶é›†å™¨**ï¼šæ”¶é›†å¹¶å…¬å¼€è¯¦ç»†çš„æ€§èƒ½å’Œè¿è¥æŒ‡æ ‡

## Prometheus æŒ‡æ ‡

LLMProxy é€šè¿‡`/metrics`ç«¯ç‚¹æä¾›å…¨é¢çš„ Prometheus æŒ‡æ ‡ï¼Œç”¨äºç›‘æ§æ€§èƒ½ã€å¥åº·çŠ¶å†µå’Œè¿è¥çŠ¶æ€ã€‚

### ä¸Šæ¸¸æŒ‡æ ‡

-   **llmproxy_upstream_requests_total**ï¼ˆè®¡æ•°å™¨ï¼‰- è½¬å‘åˆ°ä¸Šæ¸¸æœåŠ¡çš„èšåˆè¯·æ±‚æ•°ï¼ŒæŒ‰ç»„å’Œä¸Šæ¸¸æ ‡è®°
-   **llmproxy_upstream_duration_seconds**ï¼ˆç›´æ–¹å›¾ï¼‰- ä¸Šæ¸¸æœåŠ¡çš„è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒï¼ŒæŒ‰ç»„å’Œä¸Šæ¸¸æ ‡è®°
-   **llmproxy_upstream_errors_total**ï¼ˆè®¡æ•°å™¨ï¼‰- ä¸Šæ¸¸è¯·æ±‚å¤„ç†æœŸé—´é‡åˆ°çš„èšåˆé”™è¯¯æ•°ï¼ŒæŒ‰é”™è¯¯ç±»å‹ã€ç»„å’Œä¸Šæ¸¸æ ‡è®°

### HTTP è¯·æ±‚æŒ‡æ ‡

-   **llmproxy_http_requests_total**ï¼ˆè®¡æ•°å™¨ï¼‰- ä»£ç†æ¥æ”¶çš„èšåˆä¼ å…¥ HTTP è¯·æ±‚æ•°ï¼ŒæŒ‰è½¬å‘ã€æ–¹æ³•å’Œè·¯å¾„æ ‡è®°
-   **llmproxy_http_request_duration_seconds**ï¼ˆç›´æ–¹å›¾ï¼‰- ä¼ å…¥ HTTP è¯·æ±‚çš„è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒï¼ŒæŒ‰è½¬å‘ã€æ–¹æ³•å’Œè·¯å¾„æ ‡è®°
-   **llmproxy_http_request_errors_total**ï¼ˆè®¡æ•°å™¨ï¼‰- HTTP è¯·æ±‚å¤„ç†æœŸé—´é‡åˆ°çš„èšåˆé”™è¯¯æ•°ï¼ŒæŒ‰è½¬å‘ã€é”™è¯¯å’ŒçŠ¶æ€æ ‡è®°

### é€Ÿç‡é™åˆ¶æŒ‡æ ‡

-   **llmproxy_ratelimit_total**ï¼ˆè®¡æ•°å™¨ï¼‰- ç”±äºé€Ÿç‡é™åˆ¶ç­–ç•¥è€Œè¢«æ‹’ç»çš„èšåˆè¯·æ±‚æ•°ï¼ŒæŒ‰è½¬å‘æ ‡è®°

### æ–­è·¯å™¨æŒ‡æ ‡

-   **llmproxy_circuitbreaker_state_changes_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æ–­è·¯å™¨çŠ¶æ€è½¬æ¢çš„èšåˆæ•°ï¼ŒæŒ‰ç»„ã€ä¸Šæ¸¸ã€url å’ŒçŠ¶æ€æ ‡è®°
-   **llmproxy_circuitbreaker_calls_total**ï¼ˆè®¡æ•°å™¨ï¼‰- é€šè¿‡æ–­è·¯å™¨å¤„ç†çš„èšåˆè°ƒç”¨æ•°ï¼ŒæŒ‰ç»„ã€ä¸Šæ¸¸ã€url å’Œç»“æœæ ‡è®°
-   **llmproxy_circuitbreaker_opened_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æ–­è·¯å™¨è½¬æ¢ä¸ºæ‰“å¼€çŠ¶æ€çš„èšåˆæ•°ï¼ŒæŒ‰ç»„ã€ä¸Šæ¸¸å’Œ url æ ‡è®°
-   **llmproxy_circuitbreaker_closed_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æ–­è·¯å™¨è½¬æ¢ä¸ºå…³é—­çŠ¶æ€çš„èšåˆæ•°ï¼ŒæŒ‰ç»„ã€ä¸Šæ¸¸å’Œ url æ ‡è®°
-   **llmproxy_circuitbreaker_half_opened_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æ–­è·¯å™¨è½¬æ¢ä¸ºåŠå¼€çŠ¶æ€çš„èšåˆæ•°ï¼ŒæŒ‰ç»„ã€ä¸Šæ¸¸å’Œ url æ ‡è®°

## API ç«¯ç‚¹

LLMProxy å…¬å¼€ä»¥ä¸‹ HTTP API ç«¯ç‚¹ï¼š

### è½¬å‘ç«¯ç‚¹

-   **å¯é…ç½®çš„ HTTP ç«¯ç‚¹**
    -   _æè¿°_ï¼šæ¯ä¸ªè½¬å‘æœåŠ¡åœ¨å…¶é…ç½®çš„åœ°å€å’Œç«¯å£ä¸Šç›‘å¬
    -   _åè®®_ï¼šHTTP/HTTPS
    -   _ç”¨é€”_ï¼šå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå°†è¯·æ±‚å®šå‘åˆ°è¿™äº›ç«¯ç‚¹ï¼Œç„¶åè·¯ç”±åˆ°é€‚å½“çš„ä¸Šæ¸¸ LLM API

### ç®¡ç†ç«¯ç‚¹

-   **GET /health**

    -   _æè¿°_ï¼šç”¨äºç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿçš„å¥åº·æ£€æŸ¥ç«¯ç‚¹
    -   _è¿”å›_ï¼šæœåŠ¡è¿è¡Œæ­£å¸¸æ—¶è¿”å› 200 OK

-   **GET /metrics**
    -   _æè¿°_ï¼šå…¬å¼€å…¨é¢æ€§èƒ½å’Œè¿è¥ç»Ÿè®¡æ•°æ®çš„ Prometheus æŒ‡æ ‡ç«¯ç‚¹
    -   _å†…å®¹ç±»å‹_ï¼štext/plain

## ä½¿ç”¨åœºæ™¯

LLMProxy é’ˆå¯¹ä»¥ä¸‹ä¼ä¸šåœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ï¼š

-   **ä¼ä¸š AI é›†æˆ**ï¼šé›†ä¸­ LLM API è®¿é—®ï¼Œå®æ–½å¼ºå¤§çš„å®‰å…¨ç­–ç•¥ï¼Œå¹¶å®ç°å¤æ‚çš„æˆæœ¬ä¼˜åŒ–ç­–ç•¥
-   **AI åº”ç”¨ç¨‹åºå¼€å‘**ï¼šç®€åŒ–ä¸å¤šä¸ª LLM æä¾›å•†çš„é›†æˆï¼Œæ˜¾è‘—æé«˜å¯é æ€§
-   **äº‘ç¯å¢ƒ**ï¼šä½œä¸º sidecar æˆ–ç‹¬ç«‹æœåŠ¡éƒ¨ç½²ï¼Œåœ¨å¤šäº‘å’Œæ··åˆåŸºç¡€è®¾æ–½ä¸­æä¾›ç»Ÿä¸€çš„ LLM API è®¿é—®

## å“åº”æ—¶é—´æ„ŸçŸ¥çš„è´Ÿè½½å‡è¡¡ç®—æ³•

LLMProxy çš„å“åº”æ—¶é—´æ„ŸçŸ¥è´Ÿè½½å‡è¡¡ç®—æ³•æ˜¯ä¸“ä¸ºå¤§è¯­è¨€æ¨¡å‹è¿™ç±»é«˜å»¶è¿Ÿã€è®¡ç®—å¯†é›†å‹æœåŠ¡è®¾è®¡çš„æ™ºèƒ½è°ƒåº¦ç­–ç•¥ã€‚ä¸ä¼ ç»Ÿçš„è½®è¯¢æˆ–éšæœºç­–ç•¥ä¸åŒï¼Œè¯¥ç®—æ³•èƒ½å¤ŸåŠ¨æ€æ„ŸçŸ¥ä¸Šæ¸¸æœåŠ¡çš„å®é™…æ€§èƒ½è¡¨ç°ï¼Œè‡ªåŠ¨å°†è¯·æ±‚åˆ†é…ç»™å½“å‰æœ€ä½³çš„æœåŠ¡èŠ‚ç‚¹ã€‚

### å·¥ä½œåŸç†

1. **å®æ—¶æ€§èƒ½ç›‘æ§**ï¼šç³»ç»ŸæŒç»­è®°å½•æ¯ä¸ªä¸Šæ¸¸èŠ‚ç‚¹çš„å…³é”®æŒ‡æ ‡ï¼š

    - **å¹³å‡å“åº”æ—¶é—´**ï¼šä½¿ç”¨æŒ‡æ•°ç§»åŠ¨å¹³å‡ï¼ˆEMAï¼‰å¹³æ»‘å¤„ç†çš„å†å²å“åº”æ—¶é—´
    - **å½“å‰è´Ÿè½½**ï¼šæ­£åœ¨å¤„ç†ä½†å°šæœªå®Œæˆçš„è¯·æ±‚æ•°é‡
    - **æˆåŠŸç‡**ï¼šè¯·æ±‚æˆåŠŸå®Œæˆçš„æ¯”ä¾‹

2. **ç»¼åˆè¯„åˆ†æœºåˆ¶**ï¼šæ ¹æ®ä»¥ä¸‹å…¬å¼è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ç»¼åˆå¾—åˆ†ï¼Œå¾—åˆ†è¶Šä½è¡¨ç¤ºèŠ‚ç‚¹æ€§èƒ½è¶Šå¥½ï¼š

    $$\text{Score} = \text{ResponseTime} \times (\text{ProcessingRequests} + 1) \times \frac{1}{\text{SuccessRate}}$$

    å…¶ä¸­ï¼š

    - $\text{ResponseTime}$ æ˜¯èŠ‚ç‚¹çš„å¹³å‡å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    - $\text{ProcessingRequests}$ æ˜¯èŠ‚ç‚¹å½“å‰å¤„ç†ä¸­çš„è¯·æ±‚æ•°
    - $\text{SuccessRate}$ æ˜¯èŠ‚ç‚¹çš„è¯·æ±‚æˆåŠŸç‡ï¼ˆ0-1 ä¹‹é—´çš„å€¼ï¼‰

![score](./images/response_aware_parameter_impact_cn.png)

1. **æ™ºèƒ½é€‰æ‹©æµç¨‹**ï¼š

    - ä»å½“å‰è½®è¯¢ä½ç½®å¼€å§‹ï¼Œéå†æ‰€æœ‰å¥åº·çš„ä¸Šæ¸¸èŠ‚ç‚¹
    - è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ç»¼åˆå¾—åˆ†
    - é€‰æ‹©å¾—åˆ†æœ€ä½ï¼ˆæ€§èƒ½æœ€ä½³ï¼‰çš„èŠ‚ç‚¹å¤„ç†è¯·æ±‚
    - å¢åŠ æ‰€é€‰èŠ‚ç‚¹çš„å¤„ç†ä¸­è¯·æ±‚è®¡æ•°

2. **è‡ªé€‚åº”è°ƒæ•´**ï¼š
    - è¯·æ±‚å®Œæˆåï¼Œè®°å½•å®é™…å“åº”æ—¶é—´
    - ä½¿ç”¨å¹³æ»‘å› å­ï¼ˆé»˜è®¤ 0.15ï¼‰æ›´æ–°èŠ‚ç‚¹çš„å¹³å‡å“åº”æ—¶é—´
    - å‡å°‘å¤„ç†ä¸­è¯·æ±‚è®¡æ•°
    - æ›´æ–°èŠ‚ç‚¹æˆåŠŸç‡

### ä¼˜åŠ¿ç‰¹ç‚¹

-   **åŠ¨æ€é€‚åº”æ€§**ï¼šè‡ªåŠ¨é€‚åº”ä¸Šæ¸¸æœåŠ¡æ€§èƒ½å˜åŒ–ï¼Œæ— éœ€äººå·¥å¹²é¢„
-   **è´Ÿè½½å‡è¡¡**ï¼šåŒæ—¶è€ƒè™‘å“åº”æ—¶é—´å’Œå½“å‰è´Ÿè½½ï¼Œé¿å…ä»»ä½•å•ç‚¹è¿‡è½½
-   **å¹³æ»‘è¿‡æ¸¡**ï¼šä½¿ç”¨æŒ‡æ•°ç§»åŠ¨å¹³å‡æŠ€æœ¯å¹³æ»‘çŸ­æœŸæ³¢åŠ¨ï¼Œæä¾›ç¨³å®šçš„è´Ÿè½½åˆ†é…
-   **é«˜å¹¶å‘æ”¯æŒ**ï¼šé‡‡ç”¨æ— é”è®¾è®¡å’ŒåŸå­æ“ä½œï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¿æŒé«˜æ•ˆè¿è¡Œ
-   **è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼šç»“åˆç†”æ–­å™¨æœºåˆ¶ï¼Œè‡ªåŠ¨è·³è¿‡ä¸å¥åº·çš„èŠ‚ç‚¹

### é€‚ç”¨åœºæ™¯

è¯¥ç®—æ³•ç‰¹åˆ«é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š

-   **å¤§è¯­è¨€æ¨¡å‹ API ä»£ç†**ï¼šå¤„ç†å»¶è¿Ÿä»å‡ ç™¾æ¯«ç§’åˆ°å‡ åç§’ä¸ç­‰çš„ LLM è¯·æ±‚
-   **å¼‚æ„æœåŠ¡ç¯å¢ƒ**ï¼šä¸Šæ¸¸æœåŠ¡å™¨çš„ç¡¬ä»¶é…ç½®ã€è´Ÿè½½æˆ–ç½‘ç»œæ¡ä»¶å­˜åœ¨å·®å¼‚
-   **éœ€æ±‚æ³¢åŠ¨åœºæ™¯**ï¼šæœåŠ¡è´Ÿè½½éšæ—¶é—´å˜åŒ–æ˜æ˜¾çš„åº”ç”¨
-   **é«˜å¯ç”¨æ€§è¦æ±‚**ï¼šå¯¹æœåŠ¡è´¨é‡å’Œå“åº”æ—¶é—´æœ‰ä¸¥æ ¼è¦æ±‚çš„ä¼ä¸šçº§åº”ç”¨

### é…ç½®ç¤ºä¾‹

```yaml
upstream_groups:
    - name: "llm_services"
      upstreams:
          # æ³¨æ„ï¼šå“åº”æ—¶é—´æ„ŸçŸ¥ç­–ç•¥ä¸ä½¿ç”¨æƒé‡å€¼
          - name: "openai_service"
          - name: "anthropic_service"
      balance:
          strategy: "response_aware" # å¯ç”¨å“åº”æ—¶é—´æ„ŸçŸ¥è´Ÿè½½å‡è¡¡
```

## ç†”æ–­å™¨æœºåˆ¶

LLMProxy é›†æˆäº†å¼ºå¤§çš„ç†”æ–­å™¨ï¼ˆCircuit Breakerï¼‰æ¨¡å¼ï¼Œç”¨äºå¢å¼ºç³»ç»Ÿçš„å¼¹æ€§å’Œç¨³å®šæ€§ã€‚ç†”æ–­å™¨èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹æ•…éšœçš„ä¸Šæ¸¸æœåŠ¡ï¼Œå¿«é€Ÿ"æ–­å¼€"è¿æ¥ä»¥é¿å…èµ„æºæµªè´¹å’Œè¯·æ±‚å †ç§¯ï¼Œå¹¶åœ¨æœåŠ¡æ¢å¤åè‡ªåŠ¨é‡æ–°å¯ç”¨ã€‚

### å·¥ä½œåŸç†

ç†”æ–­å™¨éµå¾ªä¸‰ç§çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸï¼š

1. **å…³é—­çŠ¶æ€ï¼ˆClosedï¼‰**ï¼š

    - æ­£å¸¸çŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°ä¸Šæ¸¸æœåŠ¡
    - æŒç»­ç›‘æ§è¯·æ±‚çš„æˆåŠŸ/å¤±è´¥æƒ…å†µ
    - å½“å¤±è´¥ç‡è¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼ˆå¦‚ 50%ï¼‰æ—¶ï¼Œè½¬æ¢ä¸ºå¼€å¯çŠ¶æ€

2. **å¼€å¯çŠ¶æ€ï¼ˆOpenï¼‰**ï¼š

    - ç†”æ–­æ¿€æ´»ï¼Œå¿«é€Ÿæ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼Œä¸å†è½¬å‘åˆ°æ•…éšœä¸Šæ¸¸
    - è¿”å›å¿«é€Ÿå¤±è´¥å“åº”ï¼Œé¿å…è¯·æ±‚ç­‰å¾…å’Œèµ„æºæ¶ˆè€—
    - åœ¨é…ç½®çš„å†·å´æ—¶é—´ï¼ˆå¦‚ 30 ç§’ï¼‰åï¼Œè½¬æ¢ä¸ºåŠå¼€çŠ¶æ€

3. **åŠå¼€çŠ¶æ€ï¼ˆHalf-Openï¼‰**ï¼š
    - å…è®¸æœ‰é™æ•°é‡çš„"æ¢æµ‹"è¯·æ±‚é€šè¿‡ï¼Œæµ‹è¯•ä¸Šæ¸¸æœåŠ¡æ˜¯å¦æ¢å¤
    - å¦‚æœè¿™äº›è¯·æ±‚æˆåŠŸï¼Œè®¤ä¸ºæœåŠ¡å·²æ¢å¤ï¼Œè½¬æ¢å›å…³é—­çŠ¶æ€
    - å¦‚æœè¿™äº›è¯·æ±‚ä»ç„¶å¤±è´¥ï¼Œå›åˆ°å¼€å¯çŠ¶æ€ï¼Œç»§ç»­éš”ç¦»æ•…éšœæœåŠ¡

### æ™ºèƒ½æ•…éšœè½¬ç§»

ç†”æ–­å™¨ä¸è´Ÿè½½å‡è¡¡å™¨ç´§å¯†é›†æˆï¼Œæä¾›æ™ºèƒ½æ•…éšœè½¬ç§»èƒ½åŠ›ï¼š

-   å½“ä¸€ä¸ªä¸Šæ¸¸æœåŠ¡è¢«ç†”æ–­åï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šè‡ªåŠ¨å°†æµé‡è½¬å‘åˆ°åŒä¸€ç»„å†…çš„å…¶ä»–å¥åº·æœåŠ¡
-   åªæœ‰å½“ç»„å†…æ‰€æœ‰ä¸Šæ¸¸æœåŠ¡éƒ½ä¸å¯ç”¨æ—¶ï¼Œæ‰ä¼šå‘å®¢æˆ·ç«¯è¿”å›é”™è¯¯
-   ç†”æ–­å™¨çŠ¶æ€å¯¹è´Ÿè½½å‡è¡¡å†³ç­–é€æ˜ï¼Œç¡®ä¿è¯·æ±‚æ€»æ˜¯è·¯ç”±åˆ°å¥åº·çš„ä¸Šæ¸¸

### ä¼˜åŠ¿ç‰¹ç‚¹

-   **å¿«é€Ÿå¤±è´¥**ï¼šç«‹å³è¯†åˆ«ä¸å¯ç”¨çš„æœåŠ¡ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
-   **èµ„æºä¿æŠ¤**ï¼šé˜²æ­¢å¯¹å·²çŸ¥æ•…éšœæœåŠ¡çš„è¯·æ±‚æ¶ˆè€—å®è´µèµ„æº
-   **çº§è”æ•…éšœé˜²æŠ¤**ï¼šé˜»æ­¢å•ä¸ªæœåŠ¡æ•…éšœå½±å“æ•´ä¸ªç³»ç»Ÿ
-   **è‡ªæ„ˆèƒ½åŠ›**ï¼šè‡ªåŠ¨æ£€æµ‹æœåŠ¡æ¢å¤å¹¶é‡æ–°å¯ç”¨
-   **ç»†ç²’åº¦æ§åˆ¶**ï¼šæ¯ä¸ªä¸Šæ¸¸æœåŠ¡ç‹¬ç«‹çš„ç†”æ–­å™¨é…ç½®
-   **å¯è§‚æµ‹æ€§**ï¼šé€šè¿‡ Prometheus æŒ‡æ ‡å…¨é¢ç›‘æ§ç†”æ–­å™¨çŠ¶æ€å’Œè¡Œä¸º

### é…ç½®ç¤ºä¾‹

```yaml
upstreams:
    - name: "openai_service"
      url: "https://api.openai.com/v1"
      breaker:
          threshold: 0.5 # è§¦å‘ç†”æ–­çš„å¤±è´¥ç‡é˜ˆå€¼ï¼ˆ50%ï¼‰
          cooldown: 30 # ç†”æ–­åè¿›å…¥åŠå¼€çŠ¶æ€çš„å†·å´æ—¶é—´ï¼ˆç§’ï¼‰ï¼ˆ1-3600ï¼Œé»˜è®¤ï¼š30ï¼‰

    - name: "anthropic_service"
      url: "https://api.anthropic.com"
      breaker:
          threshold: 0.3 # å¯¹é‡è¦æœåŠ¡å¯è®¾ç½®æ›´ä½çš„é˜ˆå€¼ï¼ˆ30%ï¼‰
          cooldown: 60 # å¯¹æ¢å¤è¾ƒæ…¢çš„æœåŠ¡å¯è®¾ç½®æ›´é•¿çš„å†·å´æ—¶é—´
```

## é…ç½®

LLMProxy ä½¿ç”¨ç»“æ„åŒ– YAML æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚ä»¥ä¸‹æ˜¯å…³é”®é…ç½®éƒ¨åˆ†çš„è¯¦ç»†è¯´æ˜ï¼š

### é…ç½®é€‰é¡¹è¯¦è§£

#### HTTP æœåŠ¡å™¨é…ç½®é€‰é¡¹

| é…ç½®é¡¹                                        | ç±»å‹   | é»˜è®¤å€¼    | è¯´æ˜                                        |
| --------------------------------------------- | ------ | --------- | ------------------------------------------- |
| `http_server.forwards[].name`                 | å­—ç¬¦ä¸² | -         | **[å¿…å¡«]** è½¬å‘æœåŠ¡çš„åç§°ï¼Œåœ¨é…ç½®ä¸­å¿…é¡»å”¯ä¸€ |
| `http_server.forwards[].port`                 | æ•´æ•°   | 3000      | **[å¿…å¡«]** è½¬å‘æœåŠ¡ç›‘å¬çš„ç«¯å£å·             |
| `http_server.forwards[].address`              | å­—ç¬¦ä¸² | "0.0.0.0" | è½¬å‘æœåŠ¡ç›‘å¬çš„ç½‘ç»œåœ°å€                      |
| `http_server.forwards[].upstream_group`       | å­—ç¬¦ä¸² | -         | **[å¿…å¡«]** æ­¤è½¬å‘æœåŠ¡å…³è”çš„ä¸Šæ¸¸ç»„åç§°       |
| `http_server.forwards[].ratelimit.enabled`    | å¸ƒå°”å€¼ | false     | æ˜¯å¦å¯ç”¨é€Ÿç‡é™åˆ¶                            |
| `http_server.forwards[].ratelimit.per_second` | æ•´æ•°   | 100       | æ¯ç§’å…è®¸æ¥è‡ªå•ä¸ª IP çš„æœ€å¤§è¯·æ±‚æ•°            |
| `http_server.forwards[].ratelimit.burst`      | æ•´æ•°   | 200       | å…è®¸æ¥è‡ªå•ä¸ª IP çš„çªå‘è¯·æ±‚æ•°                |
| `http_server.forwards[].timeout.connect`      | æ•´æ•°   | 10        | å®¢æˆ·ç«¯è¿æ¥åˆ° LLMProxy çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰      |
| `http_server.admin.port`                      | æ•´æ•°   | 9000      | ç®¡ç†æœåŠ¡ç›‘å¬çš„ç«¯å£å·                        |
| `http_server.admin.address`                   | å­—ç¬¦ä¸² | "0.0.0.0" | ç®¡ç†æœåŠ¡ç›‘å¬çš„ç½‘ç»œåœ°å€                      |
| `http_server.admin.timeout.connect`           | æ•´æ•°   | 10        | è¿æ¥åˆ°ç®¡ç†æ¥å£çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰              |

#### ä¸Šæ¸¸æœåŠ¡é…ç½®é€‰é¡¹

| é…ç½®é¡¹                          | ç±»å‹   | é»˜è®¤å€¼ | è¯´æ˜                                               |
| ------------------------------- | ------ | ------ | -------------------------------------------------- |
| `upstreams[].name`              | å­—ç¬¦ä¸² | -      | **[å¿…å¡«]** ä¸Šæ¸¸æœåŠ¡çš„å”¯ä¸€åç§°                      |
| `upstreams[].url`               | å­—ç¬¦ä¸² | -      | **[å¿…å¡«]** ä¸Šæ¸¸æœåŠ¡çš„å®Œæ•´åŸºç¡€ URL                  |
| `upstreams[].auth.type`         | å­—ç¬¦ä¸² | "none" | è®¤è¯ç±»å‹ï¼š`bearer`ã€`basic` æˆ– `none`              |
| `upstreams[].auth.token`        | å­—ç¬¦ä¸² | -      | å½“ `type` ä¸º `bearer` æ—¶çš„ API å¯†é’¥/ä»¤ç‰Œ           |
| `upstreams[].auth.username`     | å­—ç¬¦ä¸² | -      | å½“ `type` ä¸º `basic` æ—¶çš„ç”¨æˆ·å                    |
| `upstreams[].auth.password`     | å­—ç¬¦ä¸² | -      | å½“ `type` ä¸º `basic` æ—¶çš„å¯†ç                       |
| `upstreams[].headers[].op`      | å­—ç¬¦ä¸² | -      | HTTP å¤´éƒ¨æ“ä½œç±»å‹ï¼š`insert`ã€`replace` æˆ– `remove` |
| `upstreams[].headers[].key`     | å­—ç¬¦ä¸² | -      | è¦æ“ä½œçš„ HTTP å¤´éƒ¨åç§°                             |
| `upstreams[].headers[].value`   | å­—ç¬¦ä¸² | -      | å¯¹äº `insert` æˆ– `replace` æ“ä½œçš„å¤´éƒ¨å€¼            |
| `upstreams[].breaker.threshold` | æµ®ç‚¹æ•° | 0.5    | ç†”æ–­å™¨è§¦å‘æ‰€éœ€çš„å¤±è´¥ç‡ï¼ˆ0.01-1.0ï¼‰                 |
| `upstreams[].breaker.cooldown`  | æ•´æ•°   | 30     | ç†”æ–­å™¨å†·å´æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå³ç†”æ–­åå¤šä¹…å°è¯•è¿›å…¥åŠå¼€çŠ¶æ€ |

#### ä¸Šæ¸¸ç»„é…ç½®é€‰é¡¹

| é…ç½®é¡¹                                          | ç±»å‹   | é»˜è®¤å€¼         | è¯´æ˜                                                                            |
| ----------------------------------------------- | ------ | -------------- | ------------------------------------------------------------------------------- |
| `upstream_groups[].name`                        | å­—ç¬¦ä¸² | -              | **[å¿…å¡«]** ä¸Šæ¸¸ç»„çš„å”¯ä¸€åç§°                                                     |
| `upstream_groups[].upstreams[].name`            | å­—ç¬¦ä¸² | -              | **[å¿…å¡«]** å¼•ç”¨çš„ä¸Šæ¸¸æœåŠ¡åç§°ï¼Œå¿…é¡»åœ¨ `upstreams` éƒ¨åˆ†å®šä¹‰                      |
| `upstream_groups[].upstreams[].weight`          | æ•´æ•°   | 1              | ä»…åœ¨ `balance.strategy` ä¸º `weighted_roundrobin` æ—¶æœ‰æ•ˆçš„æƒé‡å€¼                 |
| `upstream_groups[].balance.strategy`            | å­—ç¬¦ä¸² | "roundrobin"   | è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š`roundrobin`ã€`weighted_roundrobin`ã€`random` æˆ– `response_aware` |
| `upstream_groups[].http_client.agent`           | å­—ç¬¦ä¸² | "LLMProxy/1.0" | å‘é€åˆ°ä¸Šæ¸¸çš„ User-Agent å¤´éƒ¨å€¼                                                  |
| `upstream_groups[].http_client.keepalive`       | æ•´æ•°   | 60             | TCP Keepalive æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ0-600ï¼Œ0 è¡¨ç¤ºç¦ç”¨                                     |
| `upstream_groups[].http_client.stream`          | å¸ƒå°”å€¼ | true           | æ˜¯å¦å¯ç”¨æµå¼ä¼ è¾“æ¨¡å¼ï¼Œå¯¹äº LLM API çš„æµå¼å“åº”éå¸¸é‡è¦                           |
| `upstream_groups[].http_client.timeout.connect` | æ•´æ•°   | 10             | è¿æ¥åˆ°ä¸Šæ¸¸æœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰                                                  |
| `upstream_groups[].http_client.timeout.request` | æ•´æ•°   | 300            | ä»å‘é€è¯·æ±‚åˆ°æ¥æ”¶åˆ°ä¸Šæ¸¸å®Œæ•´å“åº”çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰                                  |
| `upstream_groups[].http_client.timeout.idle`    | æ•´æ•°   | 60             | ä¸ä¸Šæ¸¸æœåŠ¡çš„è¿æ¥åœ¨æ— æ´»åŠ¨åè¢«è§†ä¸ºç©ºé—²å¹¶å…³é—­çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰                      |
| `upstream_groups[].http_client.retry.enabled`   | å¸ƒå°”å€¼ | false          | æ˜¯å¦å¯ç”¨å‘ä¸Šæ¸¸çš„è¯·æ±‚é‡è¯•                                                        |
| `upstream_groups[].http_client.retry.attempts`  | æ•´æ•°   | 3              | æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆä¸åŒ…æ‹¬é¦–æ¬¡å°è¯•ï¼‰                                                  |
| `upstream_groups[].http_client.retry.initial`   | æ•´æ•°   | 500            | é¦–æ¬¡é‡è¯•å‰çš„åˆå§‹ç­‰å¾…é—´éš”ï¼ˆæ¯«ç§’ï¼‰                                                |
| `upstream_groups[].http_client.proxy.enabled`   | å¸ƒå°”å€¼ | false          | æ˜¯å¦å¯ç”¨å‡ºç«™ä»£ç†                                                                |
| `upstream_groups[].http_client.proxy.url`       | å­—ç¬¦ä¸² | -              | ä»£ç†æœåŠ¡å™¨ URL                                                                  |

### HTTP æœåŠ¡å™¨é…ç½®

```yaml
http_server:
    # è½¬å‘æœåŠ¡é…ç½®
    forwards:
        - name: "to_mixgroup" # [å¿…éœ€] è½¬å‘æœåŠ¡çš„åç§°
          port: 3000 # [å¿…éœ€] ç›‘å¬çš„ç«¯å£
          address: "0.0.0.0" # [å¯é€‰] ç»‘å®šçš„ç½‘ç»œåœ°å€ï¼ˆé»˜è®¤ï¼š"0.0.0.0"ï¼‰
          upstream_group: "mixgroup" # [å¿…éœ€] æ­¤è½¬å‘çš„ç›®æ ‡ä¸Šæ¸¸ç»„
          ratelimit:
              enabled: true # æ˜¯å¦å¯ç”¨é€Ÿç‡é™åˆ¶ï¼ˆé»˜è®¤ï¼šfalseï¼‰
              per_second: 100 # å•ä¸ªIPæ¯ç§’æœ€å¤§è¯·æ±‚æ•°
              burst: 200 # å•ä¸ªIPçš„çªå‘å®¹é‡ï¼ˆå¿…é¡» >= per_secondï¼‰
          timeout:
              connect: 10 # å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰

    # ç®¡ç†ç•Œé¢é…ç½®
    admin:
        port: 9000 # [å¿…éœ€] ç®¡ç†ç•Œé¢ç«¯å£
        address: "0.0.0.0" # [å¯é€‰] ç»‘å®šçš„ç½‘ç»œåœ°å€ï¼ˆé»˜è®¤ï¼š"0.0.0.0"ï¼‰
        timeout:
            connect: 10 # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
```

### ä¸Šæ¸¸é…ç½®

```yaml
upstreams:
    - name: "openai_primary" # [å¿…éœ€] æ­¤ä¸Šæ¸¸çš„å”¯ä¸€åç§°
      url: "https://api.openai.com/v1" # [å¿…éœ€] ä¸Šæ¸¸APIçš„åŸºç¡€URL
      auth:
          type: "bearer" # è®¤è¯ç±»å‹ï¼š"bearer"ã€"basic"æˆ–"none"ï¼ˆé»˜è®¤ï¼‰
          token: "YOUR_API_KEY" # [bearerè®¤è¯å¿…éœ€] APIå¯†é’¥/ä»¤ç‰Œ
          # username: "user"             # [basicè®¤è¯å¿…éœ€] ç”¨æˆ·å
          # password: "pass"             # [basicè®¤è¯å¿…éœ€] å¯†ç 
      headers:
          - op: "insert" # æ“ä½œï¼š"insert"ã€"replace"æˆ–"remove"
            key: "X-Custom-Header" # è¦æ“ä½œçš„å¤´éƒ¨åç§°
            value: "MyProxyValue" # å¤´éƒ¨å€¼ï¼ˆç”¨äº"insert"æˆ–"replace"æ“ä½œï¼‰
      breaker: # [å¯é€‰] æ–­è·¯å™¨é…ç½®
          threshold: 0.5 # è§¦å‘æ–­è·¯å™¨çš„æ•…éšœç‡é˜ˆå€¼ï¼ˆ0.01-1.0ï¼Œé»˜è®¤ï¼š0.5ï¼‰
          cooldown: 30 # è¿›å…¥åŠå¼€çŠ¶æ€å‰çš„å†·å´æœŸï¼ˆç§’ï¼‰ï¼ˆ1-3600ï¼Œé»˜è®¤ï¼š30ï¼‰

    - name: "anthropic_primary"
      url: "https://api.anthropic.com"
      auth:
          type: "bearer"
          token: "YOUR_API_KEY"
      headers:
          - op: "insert"
            key: "x-api-key" # æŸäº›APIå¯èƒ½éœ€è¦åœ¨å¤´éƒ¨ä¸­æä¾›å¯†é’¥
            value: "YOUR_API_KEY"
```

### ä¸Šæ¸¸ç»„é…ç½®

```yaml
upstream_groups:
    - name: "mixgroup" # [å¿…éœ€] æ­¤ç»„çš„å”¯ä¸€åç§°
      upstreams: # [å¿…éœ€] ä¸Šæ¸¸å¼•ç”¨åˆ—è¡¨
          - name: "openai_primary" # å¿…é¡»åŒ¹é…ä¸Šé¢å®šä¹‰çš„ä¸Šæ¸¸åç§°
            weight: 8 # [å¯é€‰] ä»…åœ¨åŠ æƒè½®è¯¢(weighted_roundrobin)ç­–ç•¥ä¸­æœ‰æ•ˆï¼Œå…¶ä»–ç­–ç•¥å¿½ç•¥æ­¤å€¼
          - name: "anthropic_primary"
            weight: 2 # ä»…åœ¨åŠ æƒè½®è¯¢ç­–ç•¥ä¸­æœ‰æ•ˆ
      balance:
          strategy:
              "weighted_roundrobin" # è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š"roundrobin"ï¼ˆé»˜è®¤ï¼‰ã€
              # "weighted_roundrobin"ã€"random"æˆ–"response_aware"
      http_client:
          agent: "LLMProxy/1.0" # [å¯é€‰] User-Agentå¤´éƒ¨ï¼ˆé»˜è®¤ï¼š"LLMProxy/1.0"ï¼‰
          keepalive: 60 # [å¯é€‰] TCPä¿æ´»ï¼ˆç§’ï¼‰ï¼ˆ0-600ï¼Œ0=ç¦ç”¨ï¼‰
          stream: true # [å¯é€‰] å¯ç”¨æµæ¨¡å¼ï¼ˆé»˜è®¤ï¼štrueï¼‰
          timeout:
              connect: 10 # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰ï¼ˆé»˜è®¤ï¼š10ï¼‰
              request: 300 # è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰ï¼ˆé»˜è®¤ï¼š300ï¼‰
              idle: 60 # ç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰ï¼ˆé»˜è®¤ï¼š60ï¼‰
          retry:
              enabled: true # æ˜¯å¦å¯ç”¨é‡è¯•ï¼ˆé»˜è®¤ï¼šfalseï¼‰
              attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°
              initial: 500 # åˆå§‹é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
          proxy:
              enabled: false # æ˜¯å¦ä½¿ç”¨å‡ºç«™ä»£ç†ï¼ˆé»˜è®¤ï¼šfalseï¼‰
              url: "http://user:pass@proxy:8080" # ä»£ç†æœåŠ¡å™¨URL
```

### é…ç½®æœ€ä½³å®è·µ

1. **å®‰å…¨è€ƒè™‘**ï¼š

    - å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå®æ–½åŒ…å«æ•æ„Ÿ API å¯†é’¥çš„é…ç½®æ–‡ä»¶çš„å®‰å…¨å­˜å‚¨
    - åˆ©ç”¨ç¯å¢ƒå˜é‡æˆ–ä¸“ç”¨çš„å¯†é’¥ç®¡ç†æœåŠ¡è¿›è¡Œå‡­æ®ç®¡ç†
    - é€šè¿‡ç»‘å®šåˆ° localhostï¼ˆ`127.0.0.1`ï¼‰å¹¶å®æ–½é€‚å½“çš„èº«ä»½éªŒè¯æ¥é™åˆ¶ç®¡ç†ç•Œé¢è®¿é—®

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š

    - æ ¹æ®ç‰¹å®š LLM æä¾›å•†çš„å“åº”ç‰¹æ€§å¾®è°ƒè¶…æ—¶é…ç½®
    - å¯ç”¨`stream: true`ä»¥é«˜æ•ˆæµå¼ä¼ è¾“ LLM å“åº”
    - å®æ–½é€‚å½“çš„é€Ÿç‡é™åˆ¶ï¼Œä¿æŠ¤ä»£ç†åŸºç¡€è®¾æ–½å’Œä¸Šæ¸¸æœåŠ¡

3. **å¯é æ€§å¢å¼º**ï¼š
    - ä¸ºå¹‚ç­‰è¯·æ±‚å¯ç”¨æ™ºèƒ½é‡è¯•æœºåˆ¶
    - å®æ–½åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡ï¼Œä¼˜å…ˆè€ƒè™‘æ›´å¯é æˆ–æ›´é«˜å®¹é‡çš„æä¾›å•†
    - åœ¨æ¯ä¸ªç»„ä¸­é…ç½®å¤šä¸ªä¸Šæ¸¸ï¼Œå®ç°å†—ä½™å’Œæ•…éšœè½¬ç§»èƒ½åŠ›
    - éƒ¨ç½²å…·æœ‰é€‚å½“é˜ˆå€¼çš„æ–­è·¯å™¨ï¼Œå¿«é€Ÿéš”ç¦»æ•…éšœæœåŠ¡
    - æ ¹æ®ä¸Šæ¸¸æ¢å¤æ¨¡å¼è®¾ç½®åˆç†çš„æ–­è·¯å™¨å†·å´æœŸ
    - ç›‘æ§æ–­è·¯å™¨æŒ‡æ ‡ï¼Œè¯†åˆ«åå¤å‡ºç°çš„ä¸Šæ¸¸ç¨³å®šæ€§é—®é¢˜
    - å¯¹äºé«˜å»¶è¿Ÿåœºæ™¯ï¼ˆå¦‚å¤§è¯­è¨€æ¨¡å‹ï¼‰ï¼Œä½¿ç”¨å“åº”æ—¶é—´æ„ŸçŸ¥çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
    - åˆ©ç”¨å“åº”æ—¶é—´æ„ŸçŸ¥è´Ÿè½½å‡è¡¡è‡ªåŠ¨å°†æµé‡å¼•å¯¼åˆ°æ€§èƒ½æ›´å¥½çš„ä¸Šæ¸¸æœåŠ¡

æœ‰å…³è¯¦ç»†è¯´æ˜æ‰€æœ‰å¯ç”¨é€‰é¡¹çš„ç»¼åˆé…ç½®å‚è€ƒï¼Œè¯·å‚é˜… LLMProxy é™„å¸¦çš„`config.default.yaml`æ–‡ä»¶ã€‚

## éƒ¨ç½²

LLMProxy æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼ï¼ŒåŒ…æ‹¬ Dockerã€Kubernetes å’Œä¼ ç»Ÿçš„ç³»ç»ŸæœåŠ¡ã€‚ä»¥ä¸‹æ˜¯å„ç§éƒ¨ç½²æ–¹æ³•çš„è¯¦ç»†è¯´æ˜ï¼š

### Docker éƒ¨ç½²

ä½¿ç”¨ Docker Compose æ˜¯éƒ¨ç½² LLMProxy æœ€ç®€å•çš„æ–¹å¼ä¹‹ä¸€ã€‚åœ¨é¡¹ç›®çš„ `examples/config` ç›®å½•ä¸­æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ Docker Compose é…ç½®æ–‡ä»¶ã€‚

1. **å‡†å¤‡é…ç½®æ–‡ä»¶**ï¼š

    å°†æ‚¨çš„ `config.yaml` æ–‡ä»¶æ”¾åœ¨ä¸ `docker-compose.yaml` ç›¸åŒçš„ç›®å½•ä¸­ã€‚

2. **å¯åŠ¨æœåŠ¡**ï¼š

    ```bash
    docker-compose up -d
    ```

3. **æŸ¥çœ‹æ—¥å¿—**ï¼š

    ```bash
    docker-compose logs -f
    ```

4. **åœæ­¢æœåŠ¡**ï¼š

    ```bash
    docker-compose down
    ```

Docker Compose é…ç½®ç¤ºä¾‹ï¼š

```yaml
version: "3"

services:
    llmproxy:
        image: shengyanli1982/llmproxy:latest
        container_name: llmproxy
        restart: unless-stopped
        ports:
            # è½¬å‘æœåŠ¡ç«¯å£
            - "3000:3000" # to_mixgroup
            - "3001:3001" # openai_group
            # ç®¡ç†ç•Œé¢ç«¯å£
            - "9000:9000" # admin
        volumes:
            - ./config.yaml:/app/config.yaml:ro
        command: ["--config", "/app/config.yaml"]
        environment:
            - TZ=Asia/Shanghai
        networks:
            - llmproxy-network

networks:
    llmproxy-network:
        driver: bridge
```

### Kubernetes éƒ¨ç½²

å¯¹äº Kubernetes ç¯å¢ƒï¼Œæˆ‘ä»¬æä¾›äº†å®Œæ•´çš„éƒ¨ç½²é…ç½®æ–‡ä»¶ï¼Œä½äº `examples/config/kubernetes` ç›®å½•ä¸­ã€‚

1. **åˆ›å»ºå‘½åç©ºé—´å’Œé…ç½®**ï¼š

    ```bash
    # è®¾ç½® API å¯†é’¥ç¯å¢ƒå˜é‡
    export OPENAI_API_KEY="your_openai_api_key"
    export ANTHROPIC_API_KEY="your_anthropic_api_key"

    # è¿›å…¥ kubernetes é…ç½®ç›®å½•
    cd examples/config/kubernetes

    # ä½¿ç”¨éƒ¨ç½²è„šæœ¬
    kubectl apply -f namespace.yaml
    kubectl apply -f configmap.yaml
    kubectl apply -f service.yaml
    kubectl apply -f deployment.yaml
    ```

2. **éªŒè¯éƒ¨ç½²**ï¼š

    ```bash
    kubectl get pods -n llmproxy
    kubectl get services -n llmproxy
    ```

3. **è®¿é—®æœåŠ¡**ï¼š

    å¦‚æœæ‚¨åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨æœåŠ¡åç§°ï¼š

    ```
    http://llmproxy.llmproxy.svc.cluster.local:3000
    ```

    å¦‚æœéœ€è¦ä»é›†ç¾¤å¤–éƒ¨è®¿é—®ï¼Œå¯ä»¥è®¾ç½® Ingress æˆ–ä½¿ç”¨ç«¯å£è½¬å‘ï¼š

    ```bash
    kubectl port-forward svc/llmproxy -n llmproxy 3000:3000 3001:3001 9000:9000
    ```

### Linux ç³»ç»ŸæœåŠ¡éƒ¨ç½²

å¯¹äºä¼ ç»Ÿçš„ Linux æœåŠ¡å™¨éƒ¨ç½²ï¼Œæˆ‘ä»¬æä¾›äº† systemd æœåŠ¡æ–‡ä»¶ã€‚

1. **ä¸‹è½½å¹¶å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶**ï¼š

    ```bash
    # ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
    curl -L -o llmproxyd https://github.com/shengyanli1982/llmproxy/releases/latest/download/llmproxyd-Linux-x64-<version>.zip

    # è§£å‹ zip
    unzip -x llmproxyd-Linux-x64-<version>.zip

    # æ·»åŠ æ‰§è¡Œæƒé™
    chmod +x llmproxyd

    # ç§»åŠ¨åˆ°ç³»ç»Ÿç›®å½•
    sudo mkdir -p /opt/llmproxy
    sudo mv llmproxyd /opt/llmproxy/
    ```

2. **åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š

    ```bash
    sudo mkdir -p /opt/llmproxy
    sudo nano /opt/llmproxy/config.yaml
    # å°†æ‚¨çš„é…ç½®ç²˜è´´åˆ°ç¼–è¾‘å™¨ä¸­
    ```

3. **åˆ›å»ºç³»ç»Ÿç”¨æˆ·**ï¼š

    ```bash
    sudo useradd -r -s /bin/false llmproxy
    sudo chown -R llmproxy:llmproxy /opt/llmproxy
    ```

4. **å®‰è£… systemd æœåŠ¡æ–‡ä»¶**ï¼š

    ```bash
    sudo cp examples/config/llmproxy.service /etc/systemd/system/
    sudo systemctl daemon-reload
    ```

5. **å¯åŠ¨å’Œå¯ç”¨æœåŠ¡**ï¼š

    ```bash
    sudo systemctl start llmproxy
    sudo systemctl enable llmproxy
    ```

6. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**ï¼š

    ```bash
    sudo systemctl status llmproxy
    ```

### å®‰å…¨å»ºè®®

æ— è®ºæ‚¨é€‰æ‹©å“ªç§éƒ¨ç½²æ–¹å¼ï¼Œéƒ½åº”è€ƒè™‘ä»¥ä¸‹å®‰å…¨æœ€ä½³å®è·µï¼š

1. **API å¯†é’¥ä¿æŠ¤**ï¼š

    - é¿å…åœ¨é…ç½®æ–‡ä»¶ä¸­ç¡¬ç¼–ç  API å¯†é’¥
    - ä½¿ç”¨ç¯å¢ƒå˜é‡ã€å¯†é’¥ç®¡ç†æœåŠ¡æˆ– Kubernetes Secrets

2. **ç½‘ç»œå®‰å…¨**ï¼š

    - é™åˆ¶ç®¡ç†æ¥å£ï¼ˆç«¯å£ 9000ï¼‰çš„è®¿é—®ï¼Œä»…å¯¹å†…éƒ¨ç½‘ç»œå¼€æ”¾
    - è€ƒè™‘ä½¿ç”¨åå‘ä»£ç†ï¼ˆå¦‚ Nginxï¼‰æ·»åŠ é¢å¤–çš„èº«ä»½éªŒè¯å±‚

3. **æœ€å°æƒé™åŸåˆ™**ï¼š

    - ä½¿ç”¨ä¸“ç”¨çš„éç‰¹æƒç”¨æˆ·è¿è¡ŒæœåŠ¡
    - é™åˆ¶æœåŠ¡å¯¹æ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®æƒé™

4. **ç›‘æ§å’Œæ—¥å¿—**ï¼š
    - é…ç½®æ—¥å¿—èšåˆå’Œç›‘æ§
    - è®¾ç½® Prometheus å‘Šè­¦ä»¥æ£€æµ‹å¼‚å¸¸è¡Œä¸º

## è®¸å¯è¯

[MIT è®¸å¯è¯](LICENSE)
