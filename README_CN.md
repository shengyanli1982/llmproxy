[English](./README.md) | ä¸­æ–‡

<div align="center">
    <img src="./images/logo.png" alt="logo" width="650">
</div>

**ä¸€æ¬¾å…·æœ‰æ™ºèƒ½è°ƒåº¦åŠŸèƒ½çš„ä¼ä¸šçº§è´Ÿè½½å‡è¡¡ç³»ç»Ÿï¼Œå¯ç»Ÿä¸€è°ƒåº¦å„ç±»å¤§è¯­è¨€æ¨¡å‹ï¼ˆå…¬æœ‰äº‘/ç§æœ‰äº‘ã€vLLMã€Ollama ç­‰ï¼‰ï¼Œå®ç°å¤šäº‘å’Œæ··åˆäº‘çš„æ— ç¼é›†æˆï¼Œå¹¶ä¸”ä»…éœ€å¯¹å®¢æˆ·ç«¯ä»£ç è¿›è¡Œæœ€å°åŒ–ä¿®æ”¹ã€‚**

## ç®€ä»‹

**LLMProxy** æ˜¯ä¸€æ¬¾ä¸“ä¸ºå¤§è¯­è¨€æ¨¡å‹ API è®¾è®¡çš„ä¼ä¸šçº§é«˜å¯ç”¨ä»£ç†æœåŠ¡ã€‚å®ƒèƒ½æ‹¦æˆªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œé€šè¿‡å¯é…ç½®çš„è·¯ç”±ç­–ç•¥å°†è¯·æ±‚æ™ºèƒ½è½¬å‘è‡³ä¸Šæ¸¸ LLM API æœåŠ¡å™¨ï¼Œå¹¶å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¯¥è§£å†³æ–¹æ¡ˆæœ‰æ•ˆè§£å†³äº† LLM API è°ƒç”¨ä¸­çš„è´¨é‡å’Œå¯é æ€§æŒ‘æˆ˜ï¼Œæä¾›ç²¾ç»†åŒ–çš„æµé‡ç®¡ç†ï¼Œæ˜¾è‘—æå‡äº†å¤§è¯­è¨€æ¨¡å‹ API äº¤äº’çš„ç¨³å®šæ€§ã€æ€§èƒ½å’Œæ•ˆç‡ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© LLMProxyï¼Ÿ

LLMProxy æœ‰æ•ˆè§£å†³äº†ä¼ä¸šçº§ LLM API éƒ¨ç½²ä¸­çš„å…³é”®æŒ‘æˆ˜ï¼š

-   **é«˜å¯ç”¨æ€§** - é€šè¿‡è·¨å¤šä¸ª LLM æä¾›å•†çš„æ™ºèƒ½è¯·æ±‚åˆ†å‘æœºåˆ¶ï¼Œå½»åº•æ¶ˆé™¤å•ç‚¹æ•…éšœé£é™©
-   **è´Ÿè½½å‡è¡¡** - å®ç°å¤æ‚çš„è´Ÿè½½åˆ†é…ç­–ç•¥ï¼Œä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡ï¼Œåœ¨å„ç§è´Ÿè½½æ¡ä»¶ä¸‹ä¿æŒç¨³å®šæ€§èƒ½
-   **å®¹é”™èƒ½åŠ›** - é‡‡ç”¨æ–­è·¯å™¨æ¨¡å¼å®æ—¶æ£€æµ‹æ•…éšœä¸Šæ¸¸æœåŠ¡ï¼Œæœ‰æ•ˆé˜²æ­¢çº§è”æ•…éšœï¼Œå¹¶åœ¨æœåŠ¡æ¢å¤åè‡ªåŠ¨é‡è¿
-   **æ°´å¹³æ‰©å±•æ€§** - åªéœ€æ·»åŠ æ›´å¤šä¸Šæ¸¸æœåŠ¡å³å¯è½»æ¾åº”å¯¹ä¸æ–­å¢é•¿çš„è¯·æ±‚é‡ï¼Œä¸”ä¸å½±å“ç°æœ‰å®¢æˆ·ç«¯

## æ ¸å¿ƒåŠŸèƒ½

-   ğŸ”„ **é«˜çº§è¯·æ±‚è½¬å‘**

    -   é€šè¿‡`http_server.forwards`é…ç½®å¤šä¸ªç‹¬ç«‹è½¬å‘æœåŠ¡
    -   å¯¹æ¯ä¸ªè½¬å‘æœåŠ¡å®ç°ç²¾ç¡®å‘½åå’Œç‹¬ç«‹é…ç½®
    -   ä¸ºæ¯ä¸ªè½¬å‘æœåŠ¡å®šåˆ¶ä¸“å±ç›‘å¬åœ°å€å’Œç«¯å£
    -   ä½¿ç”¨æ˜ç¡®çš„è·¯ç”±è§„åˆ™å°†è½¬å‘æœåŠ¡æ˜ å°„è‡³æŒ‡å®šä¸Šæ¸¸æœåŠ¡ç»„

-   ğŸŒ **å…¨é¢çš„ä¸Šæ¸¸ç®¡ç†**

    -   é€šè¿‡`upstreams`å®šä¹‰å’Œçµæ´»ç¼–æ’å¤šä¸ªåç«¯ LLM API æœåŠ¡
    -   å¯¹æ¯ä¸ªä¸Šæ¸¸æœåŠ¡è¿›è¡Œç‹¬ç«‹å‘½åã€é…ç½®ä¸ç®¡ç†
    -   æ”¯æŒä¼ä¸šçº§èº«ä»½éªŒè¯æœºåˆ¶ï¼š
        -   Bearer ä»¤ç‰Œè®¤è¯
        -   åŸºæœ¬è®¤è¯
        -   æ— è®¤è¯ï¼ˆé»˜è®¤ï¼‰
    -   ç²¾ç¡®çš„ HTTP å¤´éƒ¨æ“ä½œï¼š
        -   `insert`ï¼šå¤´éƒ¨ä¸å­˜åœ¨æ—¶æ·»åŠ 
        -   `remove`ï¼šåˆ é™¤æŒ‡å®šå¤´éƒ¨
        -   `replace`ï¼šæ›¿æ¢ç°æœ‰å¤´éƒ¨æˆ–åœ¨ä¸å­˜åœ¨æ—¶æ·»åŠ 

-   âš¡ **å¤æ‚çš„è´Ÿè½½å‡è¡¡**

    -   ä½¿ç”¨`upstream_groups`å°†ä¸Šæ¸¸æœåŠ¡ç»„ç»‡ä¸ºé€»è¾‘åŠŸèƒ½ç»„
    -   æ”¯æŒå¤šç§é«˜çº§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š
        -   **è½®è¯¢ï¼ˆRRï¼‰** - å®ç°æœåŠ¡å™¨é—´çš„å…¬å¹³åˆ†é…
        -   **åŠ æƒè½®è¯¢ï¼ˆWRRï¼‰** - æ ¹æ®æœåŠ¡å™¨å®¹é‡å’Œæ€§èƒ½è¿›è¡Œä¼˜å…ˆçº§è°ƒåº¦
        -   **éšæœº** - éç¡®å®šæ€§é€‰æ‹©ï¼Œå¢å¼ºå®‰å…¨æ€§å’Œéšç§ä¿æŠ¤
        -   **å“åº”æ—¶é—´æ„ŸçŸ¥** - åŠ¨æ€ä¼˜å…ˆé€‰æ‹©å“åº”æ›´å¿«ã€è´Ÿè½½æ›´ä½çš„æœåŠ¡å™¨
    -   åœ¨åŠ æƒè½®è¯¢ç­–ç•¥ä¸­å¯ä¸ºæ¯ä¸ªä¸Šæ¸¸è®¾ç½®æƒé‡ï¼ˆå…¶ä»–ç­–ç•¥ä¸ä½¿ç”¨æƒé‡å€¼ï¼‰

-   ğŸ” **ç²¾ç»†çš„æµé‡æ§åˆ¶**

    -   ä¸ºæ¯ä¸ªè½¬å‘æœåŠ¡é…ç½®ç²¾ç¡®é˜ˆå€¼çš„é€Ÿç‡é™åˆ¶
    -   æ ¹æ®æœåŠ¡å®¹é‡å®šåˆ¶æ¯ç§’è¯·æ±‚é™åˆ¶
    -   é…ç½®çªå‘å®¹é‡ï¼Œé«˜æ•ˆå¤„ç†æµé‡å³°å€¼
    -   å®æ–½åŸºäº IP çš„é€Ÿç‡é™åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨å¹¶ç¡®ä¿èµ„æºå…¬å¹³åˆ†é…

-   ğŸ”Œ **ä¼ä¸šçº§è¿æ¥ç®¡ç†**

    -   **å…¥ç«™è¿æ¥ç®¡ç†ï¼š** ä¸ºå®¢æˆ·ç«¯è¿æ¥é…ç½®ç²¾ç¡®è¶…æ—¶å‚æ•°
    -   **å‡ºç«™è¿æ¥å’Œè¯·æ±‚ä¼˜åŒ–ï¼š**
        -   å¯è‡ªå®šä¹‰ User-Agent æ ‡è¯†
        -   TCP ä¿æ´»é…ç½®ï¼Œç¡®ä¿è¿æ¥ç¨³å®šæ€§
        -   å¯è°ƒæ•´çš„è¿æ¥ã€è¯·æ±‚å’Œç©ºé—²è¶…æ—¶
        -   æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œæ”¯æŒå¯é…ç½®çš„å°è¯•æ¬¡æ•°å’Œé€€é¿å»¶è¿Ÿ
        -   å¯é€‰çš„ HTTP/HTTPS ä»£ç†æ”¯æŒï¼Œå¢å¼ºå®‰å…¨æ€§å’Œåˆè§„æ€§

-   ğŸ›¡ï¸ **é«˜çº§å®¹é”™æœºåˆ¶**

    -   **æ–­è·¯å™¨æ¨¡å¼ï¼š** è‡ªåŠ¨æ£€æµ‹å¹¶éš”ç¦»æ•…éšœä¸Šæ¸¸æœåŠ¡
    -   **å¿«é€Ÿæ•…éšœæ£€æµ‹ï¼š** è¿…é€Ÿè¯†åˆ«é—®é¢˜æœåŠ¡ï¼Œæœ€å°åŒ–è¯·æ±‚å»¶è¿Ÿ
    -   **è‡ªåŠ¨æ¢å¤ï¼š** å®šæœŸæµ‹è¯•æ•…éšœæœåŠ¡å¹¶åœ¨æ¢å¤æ—¶è‡ªåŠ¨é‡è¿
    -   **å¯é…ç½®é˜ˆå€¼ï¼š** é’ˆå¯¹æ¯ä¸ªä¸Šæ¸¸æœåŠ¡ç²¾ç»†è°ƒæ•´æ•…éšœæ£€æµ‹çµæ•åº¦ï¼ˆæ•…éšœç‡å’Œå†·å´æ—¶é—´ï¼‰
    -   **æ•…éšœéš”ç¦»ï¼š** å°†é—®é¢˜é™åˆ¶åœ¨å—å½±å“çš„ä¸Šæ¸¸æœåŠ¡å†…ï¼Œæœ‰æ•ˆé˜²æ­¢çº§è”æ•…éšœ
    -   **æ™ºèƒ½æ•…éšœè½¬ç§»ï¼š** å½“ä¸Šæ¸¸æœåŠ¡ç†”æ–­æ—¶ï¼Œè‡ªåŠ¨å°†æµé‡è½¬å‘è‡³åŒç»„å†…çš„å¥åº·æœåŠ¡

-   ğŸ“Š **å…¨é¢çš„ç›‘æ§ä¸ç®¡ç†**

    -   é€šè¿‡`http_server.admin`æä¾›ç‹¬ç«‹ç®¡ç†ç•Œé¢
    -   ä¸ºè¿ç»´ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿæä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹
    -   æä¾›è¯¦ç»†çš„ Prometheus æŒ‡æ ‡ï¼Œæ”¯æŒæ·±å…¥æ€§èƒ½åˆ†æ

## æ¶æ„

LLMProxy é‡‡ç”¨æ¨¡å—åŒ–ã€é¢å‘å¾®æœåŠ¡çš„æ¶æ„è®¾è®¡ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

-   **è½¬å‘æœåŠ¡å™¨**ï¼šæ¥æ”¶å¹¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„ HTTP ç›‘å¬å™¨ï¼Œè´Ÿè´£è¯·æ±‚çš„åˆæ­¥å¤„ç†å’Œè·¯ç”±
-   **ä¸Šæ¸¸ç®¡ç†å™¨**ï¼šåè°ƒä¸ LLM API æœåŠ¡å™¨çš„é€šä¿¡ï¼Œç®¡ç†è´Ÿè½½å‡è¡¡å’Œèº«ä»½éªŒè¯æµç¨‹
-   **è´Ÿè½½å‡è¡¡å™¨**ï¼šæ ¹æ®é…ç½®ç­–ç•¥ï¼ˆè½®è¯¢ã€åŠ æƒè½®è¯¢ã€éšæœºæˆ–å“åº”æ—¶é—´æ„ŸçŸ¥ï¼‰åœ¨å¯ç”¨ä¸Šæ¸¸æœåŠ¡é—´æ™ºèƒ½åˆ†é…è¯·æ±‚ï¼Œå®æ—¶é€‚åº”ä¸Šæ¸¸æ€§èƒ½å’Œè´Ÿè½½å˜åŒ–
-   **æ–­è·¯å™¨**ï¼šæŒç»­ç›‘æ§ä¸Šæ¸¸å¥åº·çŠ¶å†µï¼Œæ£€æµ‹æŒç»­å¤±è´¥çš„æœåŠ¡ï¼Œè‡ªåŠ¨ç†”æ–­å¹¶éš”ç¦»é—®é¢˜æœåŠ¡ï¼Œé˜²æ­¢æ•…éšœæ‰©æ•£ï¼Œå¹¶åœ¨æœåŠ¡æ¢å¤åè‡ªåŠ¨é‡æ–°å¯ç”¨
-   **æŒ‡æ ‡æ”¶é›†å™¨**ï¼šå®æ—¶æ”¶é›†å¹¶æš´éœ²è¯¦ç»†çš„æ€§èƒ½å’Œè¿è¥æŒ‡æ ‡ï¼Œæ”¯æŒç³»ç»Ÿç›‘æ§å’Œé—®é¢˜è¯Šæ–­

## Prometheus æŒ‡æ ‡

LLMProxy é€šè¿‡`/metrics`ç«¯ç‚¹æä¾›å…¨é¢çš„ Prometheus æŒ‡æ ‡ï¼Œç”¨äºå®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½ã€å¥åº·çŠ¶å†µå’Œè¿è¥çŠ¶æ€ã€‚

### ä¸Šæ¸¸æŒ‡æ ‡

-   **llmproxy_upstream_requests_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰ç»„å’Œä¸Šæ¸¸åˆ†ç±»ç»Ÿè®¡çš„è½¬å‘è¯·æ±‚æ€»æ•°
-   **llmproxy_upstream_duration_seconds**ï¼ˆç›´æ–¹å›¾ï¼‰- æŒ‰ç»„å’Œä¸Šæ¸¸åˆ†ç±»çš„è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ
-   **llmproxy_upstream_errors_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰é”™è¯¯ç±»å‹ã€ç»„å’Œä¸Šæ¸¸åˆ†ç±»çš„é”™è¯¯æ€»æ•°

### HTTP è¯·æ±‚æŒ‡æ ‡

-   **llmproxy_http_requests_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰è½¬å‘æœåŠ¡ã€æ–¹æ³•å’Œè·¯å¾„åˆ†ç±»çš„å…¥ç«™ HTTP è¯·æ±‚æ€»æ•°
-   **llmproxy_http_request_duration_seconds**ï¼ˆç›´æ–¹å›¾ï¼‰- æŒ‰è½¬å‘æœåŠ¡ã€æ–¹æ³•å’Œè·¯å¾„åˆ†ç±»çš„è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ
-   **llmproxy_http_request_errors_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰è½¬å‘æœåŠ¡ã€é”™è¯¯ç±»å‹å’ŒçŠ¶æ€ç åˆ†ç±»çš„é”™è¯¯æ€»æ•°

### é€Ÿç‡é™åˆ¶æŒ‡æ ‡

-   **llmproxy_ratelimit_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰è½¬å‘æœåŠ¡åˆ†ç±»çš„å› é€Ÿç‡é™åˆ¶è€Œè¢«æ‹’ç»çš„è¯·æ±‚æ€»æ•°

### æ–­è·¯å™¨æŒ‡æ ‡

-   **llmproxy_circuitbreaker_state_changes_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰ç»„ã€ä¸Šæ¸¸ã€URL å’ŒçŠ¶æ€åˆ†ç±»çš„æ–­è·¯å™¨çŠ¶æ€è½¬æ¢æ€»æ•°
-   **llmproxy_circuitbreaker_calls_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰ç»„ã€ä¸Šæ¸¸ã€URL å’Œç»“æœåˆ†ç±»çš„æ–­è·¯å™¨å¤„ç†è°ƒç”¨æ€»æ•°
-   **llmproxy_circuitbreaker_opened_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰ç»„ã€ä¸Šæ¸¸å’Œ URL åˆ†ç±»çš„æ–­è·¯å™¨å¼€å¯æ¬¡æ•°æ€»è®¡
-   **llmproxy_circuitbreaker_closed_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰ç»„ã€ä¸Šæ¸¸å’Œ URL åˆ†ç±»çš„æ–­è·¯å™¨å…³é—­æ¬¡æ•°æ€»è®¡
-   **llmproxy_circuitbreaker_half_opened_total**ï¼ˆè®¡æ•°å™¨ï¼‰- æŒ‰ç»„ã€ä¸Šæ¸¸å’Œ URL åˆ†ç±»çš„æ–­è·¯å™¨åŠå¼€çŠ¶æ€è½¬æ¢æ¬¡æ•°æ€»è®¡

## API ç«¯ç‚¹

LLMProxy å¯¹å¤–æš´éœ²ä»¥ä¸‹ HTTP API ç«¯ç‚¹ï¼š

### è½¬å‘ç«¯ç‚¹

-   **å¯é…ç½®çš„ HTTP ç«¯ç‚¹**
    -   _æè¿°_ï¼šæ¯ä¸ªè½¬å‘æœåŠ¡åœ¨å…¶é…ç½®çš„åœ°å€å’Œç«¯å£ä¸Šç›‘å¬è¯·æ±‚
    -   _åè®®_ï¼šHTTP/HTTPS
    -   _ç”¨é€”_ï¼šå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå°†è¯·æ±‚å‘é€è‡³è¿™äº›ç«¯ç‚¹ï¼Œç³»ç»Ÿéšåå°†è¯·æ±‚è·¯ç”±è‡³ç›¸åº”çš„ä¸Šæ¸¸ LLM API

### ç®¡ç†ç«¯ç‚¹

-   **GET /health**

    -   _æè¿°_ï¼šä¾›ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿä½¿ç”¨çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹
    -   _è¿”å›_ï¼šç³»ç»Ÿè¿è¡Œæ­£å¸¸æ—¶è¿”å› 200 OK çŠ¶æ€ç 

-   **GET /metrics**
    -   _æè¿°_ï¼šæä¾›å…¨é¢æ€§èƒ½å’Œè¿è¥ç»Ÿè®¡æ•°æ®çš„ Prometheus æŒ‡æ ‡ç«¯ç‚¹
    -   _å†…å®¹ç±»å‹_ï¼štext/plain

## åº”ç”¨åœºæ™¯

LLMProxy ä¸“ä¸ºä»¥ä¸‹ä¼ä¸šçº§åº”ç”¨åœºæ™¯ä¼˜åŒ–è®¾è®¡ï¼š

-   **ä¼ä¸š AI é›†æˆ**ï¼šé›†ä¸­ç®¡ç† LLM API è®¿é—®ï¼Œå®æ–½å¼ºå¤§çš„å®‰å…¨ç­–ç•¥ï¼Œä¼˜åŒ–æˆæœ¬æ§åˆ¶
-   **AI åº”ç”¨å¼€å‘**ï¼šå¤§å¹…ç®€åŒ–ä¸å¤šä¸ª LLM æä¾›å•†çš„é›†æˆæµç¨‹ï¼Œæ˜¾è‘—æå‡ç³»ç»Ÿå¯é æ€§
-   **å¤šäº‘ç¯å¢ƒéƒ¨ç½²**ï¼šå¯ä½œä¸º sidecar æˆ–ç‹¬ç«‹æœåŠ¡éƒ¨ç½²ï¼Œåœ¨å¤šäº‘å’Œæ··åˆåŸºç¡€è®¾æ–½ä¸­æä¾›ç»Ÿä¸€çš„ LLM API è®¿é—®å±‚

## å“åº”æ—¶é—´æ„ŸçŸ¥çš„è´Ÿè½½å‡è¡¡ç®—æ³•

LLMProxy çš„å“åº”æ—¶é—´æ„ŸçŸ¥è´Ÿè½½å‡è¡¡ç®—æ³•æ˜¯ä¸“ä¸ºå¤§è¯­è¨€æ¨¡å‹è¿™ç±»é«˜å»¶è¿Ÿã€è®¡ç®—å¯†é›†å‹æœåŠ¡è®¾è®¡çš„æ™ºèƒ½è°ƒåº¦ç­–ç•¥ã€‚ä¸ä¼ ç»Ÿçš„è½®è¯¢æˆ–éšæœºç­–ç•¥ä¸åŒï¼Œè¯¥ç®—æ³•èƒ½å¤Ÿå®æ—¶æ„ŸçŸ¥ä¸Šæ¸¸æœåŠ¡çš„æ€§èƒ½è¡¨ç°ï¼Œè‡ªåŠ¨å°†è¯·æ±‚åˆ†é…ç»™å½“å‰æœ€ä¼˜çš„æœåŠ¡èŠ‚ç‚¹ã€‚

### å·¥ä½œåŸç†

1. **å®æ—¶æ€§èƒ½ç›‘æ§**ï¼šç³»ç»ŸæŒç»­é‡‡é›†å¹¶è®°å½•æ¯ä¸ªä¸Šæ¸¸èŠ‚ç‚¹çš„å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼š

    - **å¹³å‡å“åº”æ—¶é—´**ï¼šé‡‡ç”¨æŒ‡æ•°ç§»åŠ¨å¹³å‡ï¼ˆEMAï¼‰å¹³æ»‘å¤„ç†çš„å†å²å“åº”æ—¶é—´
    - **å½“å‰è´Ÿè½½**ï¼šæ­£åœ¨å¤„ç†ä½†å°šæœªå®Œæˆçš„å¹¶å‘è¯·æ±‚æ•°é‡
    - **æˆåŠŸç‡**ï¼šè¯·æ±‚æˆåŠŸå®Œæˆçš„ç™¾åˆ†æ¯”

2. **ç»¼åˆè¯„åˆ†æœºåˆ¶**ï¼šæ ¹æ®ä»¥ä¸‹å…¬å¼è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ç»¼åˆæ€§èƒ½å¾—åˆ†ï¼Œå¾—åˆ†è¶Šä½è¡¨ç¤ºèŠ‚ç‚¹æ€§èƒ½è¶Šä¼˜ï¼š

    $$\text{Score} = \text{ResponseTime} \times (\text{ProcessingRequests} + 1) \times \frac{1}{\text{SuccessRate}}$$

    å…¶ä¸­ï¼š

    - $\text{ResponseTime}$ æ˜¯èŠ‚ç‚¹çš„å¹³å‡å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    - $\text{ProcessingRequests}$ æ˜¯èŠ‚ç‚¹å½“å‰å¤„ç†ä¸­çš„å¹¶å‘è¯·æ±‚æ•°
    - $\text{SuccessRate}$ æ˜¯èŠ‚ç‚¹çš„è¯·æ±‚æˆåŠŸç‡ï¼ˆ0-1 ä¹‹é—´çš„å€¼ï¼‰

![score](./images/response_aware_parameter_impact_cn.png)

3. **æ™ºèƒ½é€‰æ‹©æµç¨‹**ï¼š

    - ä»å½“å‰è½®è¯¢ä½ç½®å¼€å§‹ï¼Œéå†æ‰€æœ‰å¤„äºå¥åº·çŠ¶æ€çš„ä¸Šæ¸¸èŠ‚ç‚¹
    - åˆ†åˆ«è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ç»¼åˆæ€§èƒ½å¾—åˆ†
    - é€‰æ‹©å¾—åˆ†æœ€ä½ï¼ˆå³æ€§èƒ½æœ€ä½³ï¼‰çš„èŠ‚ç‚¹å¤„ç†å½“å‰è¯·æ±‚
    - å¢åŠ æ‰€é€‰èŠ‚ç‚¹çš„å¤„ç†ä¸­è¯·æ±‚è®¡æ•°

4. **è‡ªé€‚åº”è°ƒæ•´**ï¼š
    - è¯·æ±‚å®Œæˆåï¼Œè®°å½•å®é™…å“åº”æ—¶é—´
    - ä½¿ç”¨å¹³æ»‘å› å­ï¼ˆé»˜è®¤å€¼ 0.15ï¼‰æ›´æ–°èŠ‚ç‚¹çš„å¹³å‡å“åº”æ—¶é—´
    - å‡å°‘å¤„ç†ä¸­è¯·æ±‚è®¡æ•°
    - æ›´æ–°èŠ‚ç‚¹çš„æˆåŠŸç‡ç»Ÿè®¡

### ä¼˜åŠ¿ç‰¹ç‚¹

-   **åŠ¨æ€é€‚åº”æ€§**ï¼šè‡ªåŠ¨é€‚åº”ä¸Šæ¸¸æœåŠ¡æ€§èƒ½æ³¢åŠ¨ï¼Œæ— éœ€äººå·¥å¹²é¢„
-   **å¤šç»´åº¦è´Ÿè½½å‡è¡¡**ï¼šåŒæ—¶è€ƒè™‘å“åº”æ—¶é—´å’Œå½“å‰è´Ÿè½½ï¼Œé¿å…ä»»ä½•å•ç‚¹è¿‡è½½
-   **å¹³æ»‘è¿‡æ¸¡**ï¼šé‡‡ç”¨æŒ‡æ•°ç§»åŠ¨å¹³å‡æŠ€æœ¯å¹³æ»‘çŸ­æœŸæ³¢åŠ¨ï¼Œæä¾›ç¨³å®šçš„è´Ÿè½½åˆ†é…
-   **é«˜å¹¶å‘æ”¯æŒ**ï¼šé‡‡ç”¨æ— é”è®¾è®¡å’ŒåŸå­æ“ä½œï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¿æŒé«˜æ•ˆè¿è¡Œ
-   **è‡ªåŠ¨æ•…éšœè§„é¿**ï¼šç»“åˆç†”æ–­å™¨æœºåˆ¶ï¼Œè‡ªåŠ¨è·³è¿‡ä¸å¥åº·çš„èŠ‚ç‚¹

### é€‚ç”¨åœºæ™¯

è¯¥ç®—æ³•ç‰¹åˆ«é€‚åˆä»¥ä¸‹åº”ç”¨åœºæ™¯ï¼š

-   **å¤§è¯­è¨€æ¨¡å‹ API ä»£ç†**ï¼šå¤„ç†å»¶è¿Ÿä»æ•°ç™¾æ¯«ç§’åˆ°æ•°åç§’ä¸ç­‰çš„ LLM è¯·æ±‚
-   **å¼‚æ„æœåŠ¡ç¯å¢ƒ**ï¼šä¸Šæ¸¸æœåŠ¡å™¨åœ¨ç¡¬ä»¶é…ç½®ã€è´Ÿè½½èƒ½åŠ›æˆ–ç½‘ç»œæ¡ä»¶ä¸Šå­˜åœ¨å·®å¼‚
-   **éœ€æ±‚æ³¢åŠ¨æ˜æ˜¾**ï¼šæœåŠ¡è´Ÿè½½éšæ—¶é—´å˜åŒ–æ˜¾è‘—çš„åº”ç”¨åœºæ™¯
-   **é«˜å¯ç”¨æ€§è¦æ±‚**ï¼šå¯¹æœåŠ¡è´¨é‡å’Œå“åº”æ—¶é—´æœ‰ä¸¥æ ¼è¦æ±‚çš„ä¼ä¸šçº§åº”ç”¨

### é…ç½®ç¤ºä¾‹

```yaml
upstream_groups:
    - name: "llm_services"
      upstreams:
          # æ³¨æ„ï¼šå“åº”æ—¶é—´æ„ŸçŸ¥ç­–ç•¥ä¸ä½¿ç”¨æƒé‡å€¼
          - name: "openai_service"
          - name: "anthropic_service"
      balance:
          strategy: "response_aware" # å¯ç”¨å“åº”æ—¶é—´æ„ŸçŸ¥è´Ÿè½½å‡è¡¡
```

## ç†”æ–­å™¨æœºåˆ¶

LLMProxy é›†æˆäº†å¼ºå¤§çš„ç†”æ–­å™¨ï¼ˆCircuit Breakerï¼‰æ¨¡å¼ï¼Œç”¨äºå¢å¼ºç³»ç»Ÿçš„å¼¹æ€§å’Œç¨³å®šæ€§ã€‚ç†”æ–­å™¨èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹æ•…éšœä¸Šæ¸¸æœåŠ¡ï¼Œå¿«é€Ÿ"æ–­å¼€"è¿æ¥ä»¥é¿å…èµ„æºæµªè´¹å’Œè¯·æ±‚å †ç§¯ï¼Œå¹¶åœ¨æœåŠ¡æ¢å¤åè‡ªåŠ¨é‡æ–°æ¥å…¥ã€‚

### å·¥ä½œåŸç†

ç†”æ–­å™¨éµå¾ªä¸‰ç§çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸæ¨¡å‹ï¼š

1. **å…³é—­çŠ¶æ€ï¼ˆClosedï¼‰**ï¼š

    - ç³»ç»Ÿæ­£å¸¸è¿è¡ŒçŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚å‡ä¼šè¢«è½¬å‘åˆ°ä¸Šæ¸¸æœåŠ¡
    - æŒç»­ç›‘æ§è¯·æ±‚çš„æˆåŠŸ/å¤±è´¥æƒ…å†µ
    - å½“å¤±è´¥ç‡è¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼ˆå¦‚ 50%ï¼‰æ—¶ï¼ŒçŠ¶æ€è½¬æ¢ä¸ºå¼€å¯

2. **å¼€å¯çŠ¶æ€ï¼ˆOpenï¼‰**ï¼š

    - ç†”æ–­å™¨æ¿€æ´»ï¼Œç³»ç»Ÿå¿«é€Ÿæ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼Œä¸å†è½¬å‘åˆ°æ•…éšœä¸Šæ¸¸
    - è¿”å›å¿«é€Ÿå¤±è´¥å“åº”ï¼Œé¿å…è¯·æ±‚ç­‰å¾…å’Œèµ„æºæ¶ˆè€—
    - åœ¨é…ç½®çš„å†·å´æ—¶é—´ï¼ˆå¦‚ 30 ç§’ï¼‰åï¼ŒçŠ¶æ€è½¬æ¢ä¸ºåŠå¼€

3. **åŠå¼€çŠ¶æ€ï¼ˆHalf-Openï¼‰**ï¼š
    - ç³»ç»Ÿå…è®¸æœ‰é™æ•°é‡çš„"æ¢æµ‹"è¯·æ±‚é€šè¿‡ï¼Œæµ‹è¯•ä¸Šæ¸¸æœåŠ¡æ˜¯å¦å·²æ¢å¤
    - å¦‚æœè¿™äº›æ¢æµ‹è¯·æ±‚æˆåŠŸå®Œæˆï¼Œåˆ¤å®šæœåŠ¡å·²æ¢å¤ï¼ŒçŠ¶æ€è½¬æ¢å›å…³é—­
    - å¦‚æœæ¢æµ‹è¯·æ±‚ä»ç„¶å¤±è´¥ï¼Œå›åˆ°å¼€å¯çŠ¶æ€ï¼Œç»§ç»­éš”ç¦»æ•…éšœæœåŠ¡

### æ™ºèƒ½æ•…éšœè½¬ç§»

ç†”æ–­å™¨ä¸è´Ÿè½½å‡è¡¡å™¨ç´§å¯†é›†æˆï¼Œæä¾›æ™ºèƒ½æ•…éšœè½¬ç§»èƒ½åŠ›ï¼š

-   å½“ä¸€ä¸ªä¸Šæ¸¸æœåŠ¡è¢«ç†”æ–­åï¼Œè´Ÿè½½å‡è¡¡å™¨è‡ªåŠ¨å°†æµé‡é‡æ–°åˆ†é…åˆ°åŒä¸€ç»„å†…çš„å…¶ä»–å¥åº·æœåŠ¡
-   ä»…å½“ç»„å†…æ‰€æœ‰ä¸Šæ¸¸æœåŠ¡éƒ½ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šå‘å®¢æˆ·ç«¯è¿”å›é”™è¯¯å“åº”
-   ç†”æ–­å™¨çŠ¶æ€å¯¹è´Ÿè½½å‡è¡¡å†³ç­–ä¿æŒé€æ˜ï¼Œç¡®ä¿è¯·æ±‚å§‹ç»ˆè·¯ç”±åˆ°å¥åº·çš„ä¸Šæ¸¸æœåŠ¡

### ä¼˜åŠ¿ç‰¹ç‚¹

-   **å¿«é€Ÿå¤±è´¥æ£€æµ‹**ï¼šç«‹å³è¯†åˆ«ä¸å¯ç”¨æœåŠ¡ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…è¶…æ—¶
-   **èµ„æºä¿æŠ¤æœºåˆ¶**ï¼šé˜²æ­¢å¯¹å·²çŸ¥æ•…éšœæœåŠ¡çš„è¯·æ±‚ç»§ç»­æ¶ˆè€—å®è´µç³»ç»Ÿèµ„æº
-   **çº§è”æ•…éšœé˜²æŠ¤**ï¼šæœ‰æ•ˆé˜»æ­¢å•ä¸ªæœåŠ¡æ•…éšœæ‰©æ•£å½±å“æ•´ä¸ªç³»ç»Ÿ
-   **è‡ªæ„ˆèƒ½åŠ›**ï¼šè‡ªåŠ¨æ£€æµ‹æœåŠ¡æ¢å¤å¹¶é‡æ–°å¯ç”¨è¿æ¥
-   **ç»†ç²’åº¦æ§åˆ¶**ï¼šä¸ºæ¯ä¸ªä¸Šæ¸¸æœåŠ¡æä¾›ç‹¬ç«‹çš„ç†”æ–­å™¨é…ç½®é€‰é¡¹
-   **å…¨é¢å¯è§‚æµ‹æ€§**ï¼šé€šè¿‡ Prometheus æŒ‡æ ‡å…¨æ–¹ä½ç›‘æ§ç†”æ–­å™¨çŠ¶æ€å’Œè¡Œä¸º

### é…ç½®ç¤ºä¾‹

```yaml
upstreams:
    - name: "openai_service"
      url: "https://api.openai.com/v1"
      breaker:
          threshold: 0.5 # è§¦å‘ç†”æ–­çš„å¤±è´¥ç‡é˜ˆå€¼ï¼ˆ50%ï¼‰
          cooldown: 30 # ç†”æ–­åè¿›å…¥åŠå¼€çŠ¶æ€çš„å†·å´æ—¶é—´ï¼ˆç§’ï¼‰ï¼ˆ1-3600ï¼Œé»˜è®¤ï¼š30ï¼‰

    - name: "anthropic_service"
      url: "https://api.anthropic.com"
      breaker:
          threshold: 0.3 # å¯¹å…³é”®æœåŠ¡å¯è®¾ç½®æ›´ä½çš„é˜ˆå€¼ï¼ˆ30%ï¼‰
          cooldown: 60 # å¯¹æ¢å¤è¾ƒæ…¢çš„æœåŠ¡å¯è®¾ç½®æ›´é•¿çš„å†·å´æ—¶é—´
```

## é…ç½®

LLMProxy é‡‡ç”¨ç»“æ„åŒ– YAML æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œæä¾›çµæ´»ä¸”å¼ºå¤§çš„é…ç½®é€‰é¡¹ã€‚ä»¥ä¸‹æ˜¯å…³é”®é…ç½®éƒ¨åˆ†çš„è¯¦ç»†è¯´æ˜ï¼š

### é…ç½®é€‰é¡¹è¯¦è§£

#### HTTP æœåŠ¡å™¨é…ç½®é€‰é¡¹

| é…ç½®é¡¹                                        | ç±»å‹   | é»˜è®¤å€¼    | è¯´æ˜                                   |
| --------------------------------------------- | ------ | --------- | -------------------------------------- |
| `http_server.forwards[].name`                 | å­—ç¬¦ä¸² | -         | **[å¿…å¡«]** è½¬å‘æœåŠ¡çš„å”¯ä¸€æ ‡è¯†åç§°      |
| `http_server.forwards[].port`                 | æ•´æ•°   | 3000      | **[å¿…å¡«]** è½¬å‘æœåŠ¡çš„ç›‘å¬ç«¯å£          |
| `http_server.forwards[].address`              | å­—ç¬¦ä¸² | "0.0.0.0" | è½¬å‘æœåŠ¡çš„ç»‘å®šç½‘ç»œåœ°å€                 |
| `http_server.forwards[].upstream_group`       | å­—ç¬¦ä¸² | -         | **[å¿…å¡«]** æ­¤è½¬å‘æœåŠ¡å…³è”çš„ä¸Šæ¸¸ç»„åç§°  |
| `http_server.forwards[].ratelimit.enabled`    | å¸ƒå°”å€¼ | false     | æ˜¯å¦å¯ç”¨é€Ÿç‡é™åˆ¶åŠŸèƒ½                   |
| `http_server.forwards[].ratelimit.per_second` | æ•´æ•°   | 100       | å•ä¸ª IP æ¯ç§’å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°           |
| `http_server.forwards[].ratelimit.burst`      | æ•´æ•°   | 200       | å•ä¸ª IP å…è®¸çš„çªå‘è¯·æ±‚æ•°ï¼ˆç¼“å†²åŒºå¤§å°ï¼‰ |
| `http_server.forwards[].timeout.connect`      | æ•´æ•°   | 10        | å®¢æˆ·ç«¯è¿æ¥åˆ° LLMProxy çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `http_server.admin.port`                      | æ•´æ•°   | 9000      | ç®¡ç†æœåŠ¡çš„ç›‘å¬ç«¯å£                     |
| `http_server.admin.address`                   | å­—ç¬¦ä¸² | "0.0.0.0" | ç®¡ç†æœåŠ¡çš„ç»‘å®šç½‘ç»œåœ°å€                 |
| `http_server.admin.timeout.connect`           | æ•´æ•°   | 10        | è¿æ¥åˆ°ç®¡ç†æ¥å£çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰         |

#### ä¸Šæ¸¸æœåŠ¡é…ç½®é€‰é¡¹

| é…ç½®é¡¹                          | ç±»å‹   | é»˜è®¤å€¼ | è¯´æ˜                                               |
| ------------------------------- | ------ | ------ | -------------------------------------------------- |
| `upstreams[].name`              | å­—ç¬¦ä¸² | -      | **[å¿…å¡«]** ä¸Šæ¸¸æœåŠ¡çš„å”¯ä¸€æ ‡è¯†åç§°                  |
| `upstreams[].url`               | å­—ç¬¦ä¸² | -      | **[å¿…å¡«]** ä¸Šæ¸¸æœåŠ¡çš„åŸºç¡€ URL                      |
| `upstreams[].auth.type`         | å­—ç¬¦ä¸² | "none" | è®¤è¯ç±»å‹ï¼š`bearer`ã€`basic`æˆ–`none`                |
| `upstreams[].auth.token`        | å­—ç¬¦ä¸² | -      | å½“`type`ä¸º`bearer`æ—¶çš„ API å¯†é’¥æˆ–ä»¤ç‰Œ              |
| `upstreams[].auth.username`     | å­—ç¬¦ä¸² | -      | å½“`type`ä¸º`basic`æ—¶çš„ç”¨æˆ·å                        |
| `upstreams[].auth.password`     | å­—ç¬¦ä¸² | -      | å½“`type`ä¸º`basic`æ—¶çš„å¯†ç                           |
| `upstreams[].headers[].op`      | å­—ç¬¦ä¸² | -      | HTTP å¤´éƒ¨æ“ä½œç±»å‹ï¼š`insert`ã€`replace`æˆ–`remove`   |
| `upstreams[].headers[].key`     | å­—ç¬¦ä¸² | -      | è¦æ“ä½œçš„ HTTP å¤´éƒ¨åç§°                             |
| `upstreams[].headers[].value`   | å­—ç¬¦ä¸² | -      | ç”¨äº`insert`æˆ–`replace`æ“ä½œçš„å¤´éƒ¨å€¼                |
| `upstreams[].breaker.threshold` | æµ®ç‚¹æ•° | 0.5    | ç†”æ–­å™¨è§¦å‘é˜ˆå€¼ï¼Œè¡¨ç¤ºå¤±è´¥ç‡ï¼ˆ0.01-1.0ï¼‰             |
| `upstreams[].breaker.cooldown`  | æ•´æ•°   | 30     | ç†”æ–­å™¨å†·å´æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå³ç†”æ–­åå¤šä¹…å°è¯•è¿›å…¥åŠå¼€çŠ¶æ€ |

#### ä¸Šæ¸¸ç»„é…ç½®é€‰é¡¹

> [!NOTE] >
>
> å‚æ•° `upstreams[].url` éœ€è¦é…ç½®ä¸Šæ¸¸æœåŠ¡çš„åŸºç¡€ URLï¼Œä¾‹å¦‚ï¼š`https://api.openai.com/v1`ï¼Œè€Œä¸æ˜¯`https://api.openai.com` æˆ–è€… `https://api.openai.com/v1/chat/completions`ã€‚

| é…ç½®é¡¹                                          | ç±»å‹   | é»˜è®¤å€¼         | è¯´æ˜                                                                          |
| ----------------------------------------------- | ------ | -------------- | ----------------------------------------------------------------------------- |
| `upstream_groups[].name`                        | å­—ç¬¦ä¸² | -              | **[å¿…å¡«]** ä¸Šæ¸¸ç»„çš„å”¯ä¸€æ ‡è¯†åç§°                                               |
| `upstream_groups[].upstreams[].name`            | å­—ç¬¦ä¸² | -              | **[å¿…å¡«]** å¼•ç”¨çš„ä¸Šæ¸¸æœåŠ¡åç§°ï¼Œå¿…é¡»åœ¨`upstreams`éƒ¨åˆ†å·²å®šä¹‰                    |
| `upstream_groups[].upstreams[].weight`          | æ•´æ•°   | 1              | ä»…åœ¨`balance.strategy`ä¸º`weighted_roundrobin`æ—¶æœ‰æ•ˆçš„æƒé‡å€¼                   |
| `upstream_groups[].balance.strategy`            | å­—ç¬¦ä¸² | "roundrobin"   | è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š`roundrobin`ã€`weighted_roundrobin`ã€`random`æˆ–`response_aware` |
| `upstream_groups[].http_client.agent`           | å­—ç¬¦ä¸² | "LLMProxy/1.0" | å‘é€åˆ°ä¸Šæ¸¸çš„ User-Agent å¤´éƒ¨å€¼                                                |
| `upstream_groups[].http_client.keepalive`       | æ•´æ•°   | 60             | TCP Keepalive æ—¶é—´ï¼ˆç§’ï¼‰ï¼ŒèŒƒå›´ 0-600ï¼Œ0 è¡¨ç¤ºç¦ç”¨                              |
| `upstream_groups[].http_client.stream`          | å¸ƒå°”å€¼ | true           | æ˜¯å¦å¯ç”¨æµå¼ä¼ è¾“æ¨¡å¼ï¼Œå¯¹ LLM API çš„æµå¼å“åº”è‡³å…³é‡è¦                           |
| `upstream_groups[].http_client.timeout.connect` | æ•´æ•°   | 10             | è¿æ¥åˆ°ä¸Šæ¸¸æœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰                                                |
| `upstream_groups[].http_client.timeout.request` | æ•´æ•°   | 300            | è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œä»å‘é€è¯·æ±‚åˆ°æ¥æ”¶å®Œæ•´å“åº”çš„æœ€å¤§ç­‰å¾…æ—¶é—´                    |
| `upstream_groups[].http_client.timeout.idle`    | æ•´æ•°   | 60             | ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œè¿æ¥åœ¨æ— æ´»åŠ¨åè¢«å…³é—­çš„æ—¶é—´                            |
| `upstream_groups[].http_client.retry.enabled`   | å¸ƒå°”å€¼ | false          | æ˜¯å¦å¯ç”¨è¯·æ±‚é‡è¯•åŠŸèƒ½                                                          |
| `upstream_groups[].http_client.retry.attempts`  | æ•´æ•°   | 3              | æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆä¸åŒ…æ‹¬é¦–æ¬¡å°è¯•ï¼‰                                                |
| `upstream_groups[].http_client.retry.initial`   | æ•´æ•°   | 500            | é¦–æ¬¡é‡è¯•å‰çš„åˆå§‹ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰                                              |
| `upstream_groups[].http_client.proxy.enabled`   | å¸ƒå°”å€¼ | false          | æ˜¯å¦å¯ç”¨å‡ºç«™ä»£ç†                                                              |
| `upstream_groups[].http_client.proxy.url`       | å­—ç¬¦ä¸² | -              | ä»£ç†æœåŠ¡å™¨ URL                                                                |

### HTTP æœåŠ¡å™¨é…ç½®

```yaml
http_server:
    # è½¬å‘æœåŠ¡é…ç½®
    forwards:
        - name: "to_mixgroup" # [å¿…éœ€] è½¬å‘æœåŠ¡çš„å”¯ä¸€åç§°
          port: 3000 # [å¿…éœ€] ç›‘å¬ç«¯å£
          address: "0.0.0.0" # [å¯é€‰] ç»‘å®šçš„ç½‘ç»œåœ°å€ï¼ˆé»˜è®¤ï¼š"0.0.0.0"ï¼‰
          upstream_group: "mixgroup" # [å¿…éœ€] æ­¤è½¬å‘å¯¹åº”çš„ç›®æ ‡ä¸Šæ¸¸ç»„
          ratelimit:
              enabled: true # æ˜¯å¦å¯ç”¨é€Ÿç‡é™åˆ¶ï¼ˆé»˜è®¤ï¼šfalseï¼‰
              per_second: 100 # å•ä¸ªIPæ¯ç§’æœ€å¤§è¯·æ±‚æ•°
              burst: 200 # å•ä¸ªIPçš„çªå‘è¯·æ±‚å®¹é‡ï¼ˆå¿…é¡» >= per_secondï¼‰
          timeout:
              connect: 10 # å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

    # ç®¡ç†ç•Œé¢é…ç½®
    admin:
        port: 9000 # [å¿…éœ€] ç®¡ç†ç•Œé¢ç«¯å£
        address: "0.0.0.0" # [å¯é€‰] ç»‘å®šçš„ç½‘ç»œåœ°å€ï¼ˆé»˜è®¤ï¼š"0.0.0.0"ï¼‰
        timeout:
            connect: 10 # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
```

### ä¸Šæ¸¸æœåŠ¡é…ç½®

```yaml
upstreams:
    - name: "openai_primary" # [å¿…éœ€] ä¸Šæ¸¸æœåŠ¡çš„å”¯ä¸€æ ‡è¯†åç§°
      url: "https://api.openai.com/v1" # [å¿…éœ€] ä¸Šæ¸¸APIçš„åŸºç¡€URL
      auth:
          type: "bearer" # è®¤è¯ç±»å‹ï¼š"bearer"ã€"basic"æˆ–"none"ï¼ˆé»˜è®¤ï¼‰
          token: "YOUR_API_KEY" # [bearerè®¤è¯å¿…éœ€] APIå¯†é’¥/ä»¤ç‰Œ
          # username: "user"             # [basicè®¤è¯å¿…éœ€] ç”¨æˆ·å
          # password: "pass"             # [basicè®¤è¯å¿…éœ€] å¯†ç 
      headers:
          - op: "insert" # æ“ä½œç±»å‹ï¼š"insert"ã€"replace"æˆ–"remove"
            key: "X-Custom-Header" # è¦æ“ä½œçš„HTTPå¤´éƒ¨åç§°
            value: "MyProxyValue" # å¤´éƒ¨å€¼ï¼ˆç”¨äº"insert"æˆ–"replace"æ“ä½œï¼‰
      breaker: # [å¯é€‰] æ–­è·¯å™¨é…ç½®
          threshold: 0.5 # è§¦å‘æ–­è·¯å™¨çš„æ•…éšœç‡é˜ˆå€¼ï¼ˆ0.01-1.0ï¼Œé»˜è®¤ï¼š0.5ï¼‰
          cooldown: 30 # è¿›å…¥åŠå¼€çŠ¶æ€å‰çš„å†·å´æœŸï¼ˆç§’ï¼‰ï¼ˆ1-3600ï¼Œé»˜è®¤ï¼š30ï¼‰

    - name: "anthropic_primary"
      url: "https://api.anthropic.com"
      auth:
          type: "bearer"
          token: "YOUR_API_KEY"
      headers:
          - op: "insert"
            key: "x-api-key" # æŸäº›APIå¯èƒ½éœ€è¦åœ¨å¤´éƒ¨ä¸­é¢å¤–æä¾›å¯†é’¥
            value: "YOUR_API_KEY"
```

### ä¸Šæ¸¸ç»„é…ç½®

```yaml
upstream_groups:
    - name: "mixgroup" # [å¿…éœ€] ä¸Šæ¸¸ç»„çš„å”¯ä¸€æ ‡è¯†åç§°
      upstreams: # [å¿…éœ€] ä¸Šæ¸¸æœåŠ¡å¼•ç”¨åˆ—è¡¨
          - name: "openai_primary" # å¿…é¡»åŒ¹é…å·²å®šä¹‰çš„ä¸Šæ¸¸æœåŠ¡åç§°
            weight: 8 # [å¯é€‰] ä»…åœ¨åŠ æƒè½®è¯¢(weighted_roundrobin)ç­–ç•¥ä¸­æœ‰æ•ˆ
          - name: "anthropic_primary"
            weight: 2 # ä»…åœ¨åŠ æƒè½®è¯¢ç­–ç•¥ä¸­æœ‰æ•ˆ
      balance:
          strategy:
              "weighted_roundrobin" # è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š
              # "roundrobin"ï¼ˆé»˜è®¤ï¼‰ã€"weighted_roundrobin"ã€
              # "random"æˆ–"response_aware"
      http_client:
          agent: "LLMProxy/1.0" # [å¯é€‰] è‡ªå®šä¹‰User-Agentå¤´éƒ¨ï¼ˆé»˜è®¤ï¼š"LLMProxy/1.0"ï¼‰
          keepalive: 60 # [å¯é€‰] TCPä¿æ´»æ—¶é—´ï¼ˆç§’ï¼‰ï¼ˆ0-600ï¼Œ0=ç¦ç”¨ï¼‰
          stream: true # [å¯é€‰] å¯ç”¨æµå¼ä¼ è¾“æ¨¡å¼ï¼ˆé»˜è®¤ï¼štrueï¼‰
          timeout:
              connect: 10 # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼ˆé»˜è®¤ï¼š10ï¼‰
              request: 300 # è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼ˆé»˜è®¤ï¼š300ï¼‰
              idle: 60 # ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼ˆé»˜è®¤ï¼š60ï¼‰
          retry:
              enabled: true # æ˜¯å¦å¯ç”¨è¯·æ±‚é‡è¯•ï¼ˆé»˜è®¤ï¼šfalseï¼‰
              attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°
              initial: 500 # åˆå§‹é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
          proxy:
              enabled: false # æ˜¯å¦ä½¿ç”¨å‡ºç«™ä»£ç†ï¼ˆé»˜è®¤ï¼šfalseï¼‰
              url: "http://user:pass@proxy:8080" # ä»£ç†æœåŠ¡å™¨URL
```

### é…ç½®æœ€ä½³å®è·µ

1. **å®‰å…¨å»ºè®®**ï¼š

    - åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé‡‡ç”¨å®‰å…¨å­˜å‚¨æœºåˆ¶ä¿æŠ¤åŒ…å«æ•æ„Ÿ API å¯†é’¥çš„é…ç½®æ–‡ä»¶
    - ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–ä¸“ä¸šå¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚ Vaultã€AWS Secrets Manager ç­‰ï¼‰è¿›è¡Œå‡­æ®ç®¡ç†
    - é€šè¿‡å°†ç®¡ç†ç•Œé¢ç»‘å®šåˆ°æœ¬åœ°åœ°å€ï¼ˆ`127.0.0.1`ï¼‰å¹¶å®æ–½é€‚å½“çš„èº«ä»½éªŒè¯æœºåˆ¶ï¼Œé™åˆ¶ç®¡ç†æ¥å£çš„è®¿é—®

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š

    - æ ¹æ®ä¸åŒ LLM æä¾›å•†çš„å“åº”ç‰¹æ€§ï¼Œç²¾ç»†è°ƒæ•´å„é¡¹è¶…æ—¶é…ç½®
    - å¯¹æ”¯æŒæµå¼å“åº”çš„ LLM æœåŠ¡ï¼Œç¡®ä¿å¯ç”¨`stream: true`é…ç½®ï¼Œä¼˜åŒ–å“åº”ä¼ è¾“æ•ˆç‡
    - æ ¹æ®å®é™…ç³»ç»Ÿè´Ÿè½½å’Œä¸Šæ¸¸æœåŠ¡å®¹é‡ï¼Œé…ç½®åˆç†çš„é€Ÿç‡é™åˆ¶ï¼ŒåŒæ—¶ä¿æŠ¤ä»£ç†åŸºç¡€è®¾æ–½å’Œä¸Šæ¸¸æœåŠ¡

3. **å¯é æ€§æå‡**ï¼š
    - ä¸ºå¹‚ç­‰æ€§è¯·æ±‚å¯ç”¨æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œæé«˜è¯·æ±‚æˆåŠŸç‡
    - å®æ–½åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä¼˜å…ˆè€ƒè™‘æ›´å¯é æˆ–å¤„ç†èƒ½åŠ›æ›´å¼ºçš„æä¾›å•†
    - åœ¨æ¯ä¸ªä¸Šæ¸¸ç»„ä¸­é…ç½®å¤šä¸ªæœåŠ¡æä¾›å•†ï¼Œå®ç°å†—ä½™å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»
    - ä¸ºæ¯ä¸ªä¸Šæ¸¸æœåŠ¡é…ç½®é€‚å½“é˜ˆå€¼çš„æ–­è·¯å™¨ï¼Œå¿«é€Ÿè¯†åˆ«å¹¶éš”ç¦»æ•…éšœæœåŠ¡
    - æ ¹æ®ä¸åŒä¸Šæ¸¸æœåŠ¡çš„æ¢å¤ç‰¹æ€§ï¼Œè®¾ç½®åˆç†çš„æ–­è·¯å™¨å†·å´æœŸ
    - å®šæœŸç›‘æ§æ–­è·¯å™¨æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°å¹¶è§£å†³é¢‘ç¹å‡ºç°çš„ä¸Šæ¸¸ç¨³å®šæ€§é—®é¢˜
    - åœ¨å¤„ç†å¤§è¯­è¨€æ¨¡å‹ç­‰é«˜å»¶è¿Ÿåº”ç”¨åœºæ™¯æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨å“åº”æ—¶é—´æ„ŸçŸ¥çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
    - å……åˆ†åˆ©ç”¨å“åº”æ—¶é—´æ„ŸçŸ¥ç®—æ³•ï¼Œè‡ªåŠ¨å°†æµé‡å¼•å¯¼è‡³æ€§èƒ½æœ€ä½³çš„ä¸Šæ¸¸æœåŠ¡

æœ‰å…³æ‰€æœ‰å¯ç”¨é…ç½®é€‰é¡¹çš„è¯¦ç»†è¯´æ˜ï¼Œè¯·å‚é˜… LLMProxy é¡¹ç›®é™„å¸¦çš„`config.default.yaml`æ–‡ä»¶ä½œä¸ºå®Œæ•´å‚è€ƒã€‚

## éƒ¨ç½²æŒ‡å—

LLMProxy æ”¯æŒå¤šç§çµæ´»çš„éƒ¨ç½²æ–¹å¼ï¼ŒåŒ…æ‹¬ Docker å®¹å™¨åŒ–éƒ¨ç½²ã€Kubernetes é›†ç¾¤éƒ¨ç½²å’Œä¼ ç»Ÿ Linux ç³»ç»ŸæœåŠ¡éƒ¨ç½²ã€‚ä»¥ä¸‹æ˜¯å„éƒ¨ç½²æ–¹æ³•çš„è¯¦ç»†è¯´æ˜ï¼š

### Docker éƒ¨ç½²

ä½¿ç”¨ Docker Compose æ˜¯éƒ¨ç½² LLMProxy æœ€ä¾¿æ·çš„æ–¹å¼ä¹‹ä¸€ã€‚é¡¹ç›®çš„`examples/config`ç›®å½•ä¸­æä¾›äº†å®Œæ•´çš„ Docker Compose é…ç½®ç¤ºä¾‹ã€‚

1. **å‡†å¤‡é…ç½®æ–‡ä»¶**ï¼š

    å°†è‡ªå®šä¹‰çš„`config.yaml`æ–‡ä»¶æ”¾ç½®åœ¨ä¸`docker-compose.yaml`ç›¸åŒçš„ç›®å½•ä¸­ã€‚

2. **å¯åŠ¨æœåŠ¡**ï¼š

    ```bash
    docker-compose up -d
    ```

3. **æŸ¥çœ‹è¿è¡Œæ—¥å¿—**ï¼š

    ```bash
    docker-compose logs -f
    ```

4. **åœæ­¢æœåŠ¡**ï¼š

    ```bash
    docker-compose down
    ```

Docker Compose é…ç½®ç¤ºä¾‹ï¼š

```yaml
version: "3"

services:
    llmproxy:
        image: shengyanli1982/llmproxy:latest
        container_name: llmproxy
        restart: unless-stopped
        ports:
            # è½¬å‘æœåŠ¡ç«¯å£æ˜ å°„
            - "3000:3000" # to_mixgroup
            - "3001:3001" # openai_group
            # ç®¡ç†ç•Œé¢ç«¯å£æ˜ å°„
            - "9000:9000" # admin
        volumes:
            - ./config.yaml:/app/config.yaml:ro
        command: ["--config", "/app/config.yaml"]
        environment:
            - TZ=Asia/Shanghai
        networks:
            - llmproxy-network

networks:
    llmproxy-network:
        driver: bridge
```

### Kubernetes éƒ¨ç½²

å¯¹äº Kubernetes ç¯å¢ƒï¼Œæˆ‘ä»¬åœ¨`examples/config/kubernetes`ç›®å½•ä¸­æä¾›äº†å®Œæ•´çš„éƒ¨ç½²é…ç½®æ–‡ä»¶ã€‚

1. **åˆ›å»ºå‘½åç©ºé—´å’Œç›¸å…³èµ„æº**ï¼š

    ```bash
    # è®¾ç½®APIå¯†é’¥ç¯å¢ƒå˜é‡ï¼ˆç”¨äºé…ç½®æ–‡ä»¶æ¸²æŸ“ï¼‰
    export OPENAI_API_KEY="your_openai_api_key"
    export ANTHROPIC_API_KEY="your_anthropic_api_key"

    # è¿›å…¥kubernetesé…ç½®ç›®å½•
    cd examples/config/kubernetes

    # ä¾æ¬¡åº”ç”¨éƒ¨ç½²èµ„æº
    kubectl apply -f namespace.yaml
    kubectl apply -f configmap.yaml
    kubectl apply -f service.yaml
    kubectl apply -f deployment.yaml
    ```

2. **éªŒè¯éƒ¨ç½²çŠ¶æ€**ï¼š

    ```bash
    kubectl get pods -n llmproxy
    kubectl get services -n llmproxy
    ```

3. **è®¿é—®æœåŠ¡**ï¼š

    é›†ç¾¤å†…éƒ¨è®¿é—®ï¼ˆä½¿ç”¨æœåŠ¡åç§°ï¼‰ï¼š

    ```
    http://llmproxy.llmproxy.svc.cluster.local:3000
    ```

    ä»é›†ç¾¤å¤–éƒ¨è®¿é—®ï¼ˆå¯é…ç½® Ingress æˆ–ä½¿ç”¨ç«¯å£è½¬å‘ï¼‰ï¼š

    ```bash
    kubectl port-forward svc/llmproxy -n llmproxy 3000:3000 3001:3001 9000:9000
    ```

### Linux ç³»ç»ŸæœåŠ¡éƒ¨ç½²

å¯¹äºä¼ ç»Ÿçš„ Linux æœåŠ¡å™¨ç¯å¢ƒï¼Œæˆ‘ä»¬æä¾›äº†æ ‡å‡†çš„ systemd æœåŠ¡æ–‡ä»¶ã€‚

1. **ä¸‹è½½å¹¶å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶**ï¼š

    ```bash
    # ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
    curl -L -o llmproxyd.zip https://github.com/shengyanli1982/llmproxy/releases/latest/download/llmproxyd-Linux-x64-<version>.zip

    # è§£å‹æ–‡ä»¶
    unzip llmproxyd.zip

    # æ·»åŠ æ‰§è¡Œæƒé™
    chmod +x llmproxyd

    # ç§»åŠ¨åˆ°ç³»ç»Ÿç›®å½•
    sudo mkdir -p /opt/llmproxy
    sudo mv llmproxyd /opt/llmproxy/
    ```

2. **åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š

    ```bash
    sudo mkdir -p /opt/llmproxy
    sudo nano /opt/llmproxy/config.yaml
    # åœ¨ç¼–è¾‘å™¨ä¸­ç²˜è´´æ‚¨çš„é…ç½®å†…å®¹
    ```

3. **åˆ›å»ºä¸“ç”¨ç³»ç»Ÿç”¨æˆ·**ï¼š

    ```bash
    sudo useradd -r -s /bin/false llmproxy
    sudo chown -R llmproxy:llmproxy /opt/llmproxy
    ```

4. **å®‰è£… systemd æœåŠ¡æ–‡ä»¶**ï¼š

    ```bash
    sudo cp examples/config/llmproxy.service /etc/systemd/system/
    sudo systemctl daemon-reload
    ```

5. **å¯åŠ¨å¹¶è®¾ç½®è‡ªåŠ¨å¯åŠ¨**ï¼š

    ```bash
    sudo systemctl start llmproxy
    sudo systemctl enable llmproxy
    ```

6. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**ï¼š

    ```bash
    sudo systemctl status llmproxy
    ```

### å®‰å…¨æœ€ä½³å®è·µ

æ— è®ºé€‰æ‹©ä½•ç§éƒ¨ç½²æ–¹å¼ï¼Œéƒ½åº”è€ƒè™‘ä»¥ä¸‹å®‰å…¨æœ€ä½³å®è·µï¼š

1. **API å¯†é’¥ä¿æŠ¤**ï¼š

    - é¿å…åœ¨é…ç½®æ–‡ä»¶ä¸­ç›´æ¥ç¡¬ç¼–ç  API å¯†é’¥
    - ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ã€ä¸“ä¸šå¯†é’¥ç®¡ç†æœåŠ¡æˆ– Kubernetes Secrets
    - å®šæœŸè½®æ¢ API å¯†é’¥ï¼Œé™ä½æ½œåœ¨æ³„éœ²é£é™©

2. **ç½‘ç»œå®‰å…¨åŠ å›º**ï¼š

    - ä¸¥æ ¼é™åˆ¶ç®¡ç†æ¥å£ï¼ˆç«¯å£ 9000ï¼‰çš„è®¿é—®èŒƒå›´ï¼Œä»…å¯¹å¯ä¿¡å†…éƒ¨ç½‘ç»œå¼€æ”¾
    - è€ƒè™‘åœ¨å‰ç«¯éƒ¨ç½²åå‘ä»£ç†ï¼ˆå¦‚ Nginxã€Traefikï¼‰ï¼Œå¢åŠ é¢å¤–çš„èº«ä»½éªŒè¯å’Œ TLS åŠ å¯†å±‚
    - å®æ–½ç½‘ç»œåˆ†æ®µï¼Œç¡®ä¿ä¸åŒå®‰å…¨çº§åˆ«çš„ç»„ä»¶éš”ç¦»éƒ¨ç½²

3. **æœ€å°æƒé™åŸåˆ™**ï¼š

    - ä½¿ç”¨ä¸“ç”¨çš„éç‰¹æƒç³»ç»Ÿç”¨æˆ·è¿è¡ŒæœåŠ¡
    - ä¸¥æ ¼é™åˆ¶æœåŠ¡å¯¹æ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®æƒé™
    - é‡‡ç”¨å®¹å™¨å®‰å…¨æœ€ä½³å®è·µï¼Œå¦‚é root ç”¨æˆ·è¿è¡Œã€åªè¯»æ–‡ä»¶ç³»ç»Ÿç­‰

4. **ç›‘æ§ä¸æ—¥å¿—ç®¡ç†**ï¼š
    - é…ç½®é›†ä¸­å¼æ—¥å¿—èšåˆå’Œåˆ†æç³»ç»Ÿ
    - è®¾ç½®åŸºäº Prometheus æŒ‡æ ‡çš„å®æ—¶ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
    - å®æ–½å¼‚å¸¸æ£€æµ‹ï¼ŒåŠæ—¶å‘ç°æ½œåœ¨çš„å®‰å…¨å¨èƒæˆ–æ€§èƒ½é—®é¢˜

## è®¸å¯è¯

[MIT è®¸å¯è¯](LICENSE)
